---
title:      "XDP-tutorial å­¦ä¹ å¦‚ä½•ç¼–å†™ eBPF XDP ç¨‹åº"
subtitle:   "è·Ÿç€ xdp-tutorial repo ä»¥åŠ Linux repo bpf/samples ä»é›¶å¼€å§‹å­¦ä¹ ç¼–å†™ eBPF XDP ç¨‹åº"
date:       2022-07-18 07:00:00
author:     "p1nant0m"
header-img: "img/in-post/bg2.jpg"
lightgallery: true
tags:
    - eBPF
    - XDP
    - tutorial
---

## XDP-Tutorial

> â­ æœ¬æ–‡ç« ä»ç„¶åœ¨ä¸æ–­çš„æ›´æ–°ä¸­ï¼Œå› æ­¤æ–‡ç« ç»“æ„ä»¥åŠå†…å®¹å¯èƒ½ä¼šæ—¶å¸¸å‘ç”Ÿå˜åŒ–ã€‚åŒæ—¶æœ¬é¢†åŸŸä¹Ÿæ˜¯ä½œè€…åˆšåˆšæ¶‰åŠçš„é¢†åŸŸï¼Œéš¾å…åœ¨æ–‡æœ¬å†…å®¹ä¸­å‡ºç°é”™è¯¯ï¼Œè¿˜æœ›æŒ‡æ­£ï¼Œå¤§å®¶ä¸€åŒå­¦ä¹ å…±å‹‰ã€‚

XDP-Tutorial æ˜¯ä¸€ä¸ª Github ä¸Šçš„ repoï¼Œçš†åœ¨æŒ‡å¯¼äººä»¬å¦‚ä½•éµå¾ªæœ€åŸºæœ¬çš„æ­¥éª¤ï¼Œé«˜æ•ˆåœ°å®ç°ä¸ºå†…æ ¸ä¸­çš„ XDP ç³»ç»Ÿè¿›è¡Œç¼–ç¨‹ã€‚æˆ‘ä¼šéšç€è¿™ä¸ªè¯¾ç¨‹çš„æ­¥ä¼ä¸å¤§å®¶ä¸€åŒæ¢å¯» Linux å†…æ ¸ä¸–ç•Œçš„å¥¥ç§˜ä»¥åŠå¦‚ä½•ä½¿ç”¨é«˜æ€§èƒ½çš„ XDP ç¨‹åºå¯¹ç½‘ç»œæ•°æ®æŠ¥è¿›è¡Œå¤„ç†ã€‚éšç€å­¦ä¹ çš„æ·±å…¥ï¼Œæˆ‘ä¼šåˆ—å‡ºç†è§£æ¯ä¸€èŠ‚è¯¾ç¨‹çš„ç¼–ç¨‹å®ç°æ‰€éœ€è¦å‰ç½®çŸ¥è¯†ï¼ŒæŸ¥æ¼è¡¥ç¼ºï¼Œå¸®åŠ©æˆ‘ä»¬å¤§å®¶æ›´å¥½åœ°ç†è§£å…¶ä¸­çš„çŸ¥è¯†è„‰ç»œï¼Œä¸ºä»¥åå•ç‹¬å¼€å‘ç›¸å…³çš„ç³»ç»Ÿæä¾›æ€è·¯æ”¯æ’‘ã€‚



### XDP (eXpress Data Path) ç®€ä»‹

XDP æ˜¯ Linux å†…æ ¸ä¸Šæ¸¸ï¼ˆLinux å†…æ ¸åŸå§‹ç‰ˆæœ¬é Linux åˆ†å‘ç‰ˆï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¸ºç”¨æˆ·æä¾›äº†å°†ç”¨æˆ·ç¼–å†™çš„åŒ…å¤„ç†ç¨‹åºå®‰è£…è¿›å…¥å†…æ ¸çš„é€šé“ï¼Œå®‰è£…è¿›å…¥å†…æ ¸çš„åŒ…å¤„ç†ç¨‹åºä¼šåœ¨ç³»ç»Ÿæ¥æ”¶åˆ°åŒ…ï¼ˆè¿˜æœªå¯¹æ•°æ®åŒ…è¿›è¡Œä»»ä½•å¤„ç†ï¼‰çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œä»è€Œæä¾›äº†ä¸€ç§é«˜æ€§èƒ½çš„æ–¹å¼å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å†…æ ¸æ¥æ”¶åˆ°æ•°æ®åŒ…æ—¶çš„è¡Œä¸ºã€‚


{{< image src="https://image.p1nant0m.xyz/XDP_integration_with_linux_network_stack.png" caption="XDP ä¸å†…æ ¸åè®®æ ˆçš„æ•´åˆ" src_s="https://image.p1nant0m.xyz/XDP_integration_with_linux_network_stack.png" src_l="https://image.p1nant0m.xyz/XDP_integration_with_linux_network_stack.png" >}}




### XDP ç¨‹åºæ“ä½œæ¨¡å¼ç§ç±»

åŸç”Ÿæ¨¡å¼  (Native XDP) å¸è½½æ¨¡å¼ (Offloaded XDP) é€šç”¨æ¨¡å¼ (Generic XDP)

> Native XDPï¼š
>
> â€‹	è¯¥æ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒXDP çš„ BPF ç¨‹åº åœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºçš„æ—©æœŸæ¥æ”¶è·¯å¾„ä¹‹å¤–ç›´æ¥è¿è¡Œã€‚ä½¿ç”¨è¯¥æ¨¡å¼éœ€è¦ç¡¬ä»¶è®¾å¤‡çš„æ”¯æŒã€‚ä½¿ç”¨ `git grep -l XDP_SETUP_PROG drivers` å‘½ä»¤å¯ä»¥æ£€æŸ¥é©±åŠ¨ç¨‹åºæ˜¯å¦æ”¯æŒæ­¤æ¨¡å¼ã€‚
>
>
> Offloaded XDPï¼š
>
> â€‹	åœ¨å¸è½½æ¨¡å¼ä¸‹ï¼ŒXDP çš„ BPF ç¨‹åºç›´æ¥å¸è½½åˆ°ç½‘å¡ä¸Šï¼Œè€Œä¸æ˜¯åœ¨ä¸»æœº CPU ä¸Šæ‰§è¡Œã€‚å› æœ¬å°±ä»…æœ‰ç›¸å½“ä½å¼€é”€çš„ XDP ç¨‹åºçš„æ‰§è¡Œä» CPU ä¸Šè½¬ç§»åˆ°ç½‘å¡ä¸Šï¼Œä»è€Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæ¯”åŸç”Ÿ XDP å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚ä½¿ç”¨è¿™ç§æ“ä½œæ¨¡å¼çš„ XDP ç¨‹åºéœ€è¦å¾—åˆ°ç½‘å¡çš„æ”¯æŒã€‚ä½¿ç”¨ `git grep -l XDP_SETUP_PROG_HW drivers` å¯ä»¥æ£€æŸ¥å“ªäº›ç½‘å¡é©±åŠ¨ç¨‹åºæ”¯æŒ Offloaded æ¨¡å¼ã€‚
>
> Generic XDPï¼š
>
> â€‹	å¯¹äºæ²¡æœ‰æä¾› Offloaded æˆ– Native æ¨¡å¼æ”¯æŒçš„ç½‘å¡è®¾å¤‡æ¥è¯´ï¼Œå†…æ ¸æä¾›äº†ä¸€ä¸ªä½¿ç”¨ XDP é€šç”¨æ¨¡å¼çš„é€‰é¡¹ã€‚ä½¿ç”¨æ­¤æ¨¡å¼ä¸éœ€è¦éœ€è¦ä»»ä½•çš„é©±åŠ¨æ”¯æŒï¼Œå› ä¸ºå…¶è¿è¡Œåœ¨ä¸€ä¸ªç›¸å¯¹äºç½‘ç»œå†…æ ¸æ ˆä¸­ç›¸å¯¹é åçš„ä½ç½®ã€‚å…¶å­˜åœ¨ä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†å¼€å‘äººå‘˜åœ¨ä¸æ”¯æŒä¸Šè¿°ä¸¤ç§æ¨¡å¼çš„ç¯å¢ƒä¸­è¿›è¡Œ XDP ç¨‹åºçš„å¼€å‘ä¸è°ƒè¯•ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼ŒXDP ç¨‹åºçš„è¿è¡Œæ€§èƒ½æ²¡æœ‰å‰ä¸¤è€…é‚£ä¹ˆé«˜æ•ˆï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ 



### XDP ç¨‹åºä½¿ç”¨åœºæ™¯

- ç¼“è§£ DDoS æ”»å‡»ï¼Œé˜²ç«å¢™

  åˆ©ç”¨ XDP BPF çš„ç‰¹æ€§æˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®šä¹‰é©±åŠ¨ä¸¢å¼ƒæ¶æ„ç½‘ç»œåŒ…çš„è¡Œä¸ºé€»è¾‘ã€‚é€šè¿‡åœ¨å¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†çš„æ—©æœŸé˜¶æ®µä»¤æ•°æ®åŒ…å¤„ç†å™¨å‘ç½‘ç»œé©±åŠ¨æŠ›å‡º `XDP_DROP` ä¸¢å¼ƒæ¶æ„æ•°æ®åŒ…ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä»…ä»˜å‡ºæå°ä»£ä»·çš„æƒ…å†µä¸‹å°†æ•°æ®åŒ…ä¸¢å¼ƒï¼Œç»´æŒç³»ç»Ÿèµ„æºå¤„äºä¸€ä¸ªå¥åº·å¯ç”¨çš„çŠ¶æ€ã€‚å¦å¤–ï¼Œåˆ©ç”¨ `XDP_TX` `XDP_PASS` `XDP_REDIRECT` æˆ‘ä»¬è¿˜èƒ½å¤Ÿè‡ªå®šä¹‰é€»è¾‘å¯¹æµé‡è¿›è¡Œæ¸…æ´—ã€æ§åˆ¶æµé‡çš„èµ°å‘ï¼Œå®ç°å¯¹ä¸»æœºçš„ä¿æŠ¤ã€‚

  å€ŸåŠ© XDPï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç½‘å¡æˆ–å…¶é©±åŠ¨ç¨‹åºä¸­ä»¥å®Œå…¨å¯ç¼–ç¨‹çš„æ–¹å¼è·å¾—ç›¸åŒçš„åŠŸèƒ½ï¼Œè€Œè¿™ç›¸æ¯”äºæ˜‚è´µçš„é˜²ç«å¢™ç¡¬ä»¶è®¾å¤‡æ¥çš„éå¸¸ä¾¿å®œä¸”å¿«é€Ÿã€‚**<u>å¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿œç¨‹è°ƒç”¨ API æ›´æ”¹è§„åˆ™æ¥æ§åˆ¶æ˜ å°„ï¼Œç„¶åå°†æ˜ å°„ä¸­çš„è§„åˆ™é›†åŠ¨æ€ä¼ é€’ç»™æ¯å°ç‰¹å®šè®¡ç®—æœºä¸­åŠ è½½çš„ XDP ç¨‹åºï¼Œè¿™æ ·å°±èƒ½å¤ŸåŠ¨æ€çš„æ§åˆ¶é›†ç¾¤ä¸­ç½‘ç»œæ‹“æ‰‘ç»“æ„</u>**ã€‚

- è´Ÿè½½å‡è¡¡

  ä¸Šé¢æåˆ°è¿‡æ•°æ®åŒ…å¤„ç†å™¨å¯ä»¥é€šè¿‡å‘ç½‘ç»œé©±åŠ¨æŠ›å‡ºçŠ¶æ€ç å½±å“ç½‘ç»œé©±åŠ¨çš„å¯¹æ•°æ®åŒ…çš„è¡Œä¸ºï¼Œåœ¨è´Ÿè½½å‡è¡¡çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `XDP_TX` æˆ–è€… `XDP_REDIRECT` ï¼Œå°†ç»è¿‡ XDP ç¨‹åºå¤„ç†åçš„æ•°æ®åŒ…å‘å¾€æ¥æ”¶åˆ°è¯¥æ•°æ®åŒ…çš„ç½‘å¡æˆ–å°†å…¶æ¨è‡³å¦å¤–çš„ç½‘å¡ä¸­ä¼ è¾“ã€‚

  > ç›´æ¥å°†è¯¥æ•°æ®åŒ…ä¼ å…¥åˆ°ä¸€ç±»ç‰¹æ®Šçš„å¥—æ¥å­—å®¶æ— (AF_XDP) ä¸­

- å…ˆäºå†…æ ¸åè®®æ ˆçš„åŒ…è¿‡æ»¤/å¤„ç†

  åœ¨ Linux å†…æ ¸åè®®æ ˆæ­£å¼å¤„ç†æŠµè¾¾çš„æ•°æ®åŒ…ä¹‹å‰ï¼ŒXDP ç¨‹åºå¯ä»¥æ ¹æ®ç”¨æˆ·è‡ªå®šä¹‰çš„ç­–ç•¥å¯¹åˆ°è¾¾çš„æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ï¼Œè¿™å¯ä»¥é€šè¿‡ `XDP_DROP` æŒ‡ç¤ºç½‘ç»œé©±åŠ¨ä¸¢å¼ƒæ‰ä¸ç¬¦åˆè§„åˆ™çš„æ•°æ®åŒ…å®ç°ã€‚

  > ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬ç¡®å®šæŸä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æœåŠ¡æµé‡åªæœ‰ TCP æµé‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ XDP ç¨‹åºä¸¢å¼ƒæ‰€æœ‰ä½¿ç”¨å…¶å®ƒå››å±‚åè®®ï¼ˆUDPã€SCTPï¼‰çš„æµé‡ã€‚

  æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ XDP ç¨‹åºå»å®ç°è‡ªæœ‰åè®®çš„å°è£…ä¸è§£å°è£…ï¼Œè¿™å¯¹å†…æ ¸åè®®æ ˆæ˜¯é€æ˜çš„ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜èƒ½å¤Ÿåœ¨æ¥æ”¶åˆ°çš„æ•°æ®åŒ…å¤´éƒ¨ï¼ˆéæ•°æ®åŒ…åŒºåŸŸï¼‰å‰å¢åŠ ä¸€æ®µå…ƒæ•°æ®ï¼Œè¿™äº›å…ƒæ•°æ®å¯¹äºå†…æ ¸åè®®æ ˆæ¥è¯´æ˜¯é€æ˜çš„ï¼Œä½†å¯¹äº TC ç¨‹åºæ¥è¯´å®ƒå¯ä»¥è·å–åˆ°ç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä»è€Œæ§åˆ¶å…¶ç¨‹åºçš„è¡Œä¸ºé€»è¾‘ï¼Œå®Œæˆç›¸å…³çš„æ•°æ®åŒ…è§£æå·¥ä½œã€‚

- ç›‘æ§

  ä½¿ç”¨ XDP ç¨‹åºå¯¹åˆ°è¾¾çš„ç½‘ç»œæ•°æ®æµè¿›è¡Œç‰¹å¾ç»Ÿè®¡ä¸æµé‡åˆ†æï¼Œä¹Ÿå¯ä»¥å¯¹æ•°æ®åŒ…è¿›è¡Œä¸€äº›å¤æ‚çš„åˆ†æï¼ˆæ¯”å¦‚æ¶æ„ç‰¹å¾æå–ä¸æ£€æµ‹ï¼‰ã€‚XDP ä¸ä»¥å¾€çš„ä¸€äº›æŠ€æœ¯è§£å†³æ–¹æ¡ˆç›¸æ¯”å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š1ï¼‰XDP å…è®¸åœ¨è¾ƒæ—©çš„é˜¶æ®µå¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œä»‹å…¥ï¼Œèƒ½å¤Ÿæˆªæ–­æˆ–æ˜¯å°†æ•°æ®åŒ…ä¸­çš„è½½è·æå–å‡ºæ¥å¹¶é€šè¿‡ Linux å†…æ ¸æä¾›çš„ perf åŸºç¡€è®¾æ–½ï¼ˆå¿«é€Ÿã€æ— é”ã€æ¯ä¸€ä¸ª CPU éƒ½å…·æœ‰çš„å†…å­˜ç¯å½¢ç¼“å†²åŒºåŸŸï¼‰æ¨é€è‡³ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºä¸­è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œè¿™ç§æ•°æ®é€šè·¯çš„å¤„ç†æ€§èƒ½æ¯”ä»¥å¾€çš„è§£å†³æ–¹æ¡ˆè¦æ›´åŠ åŠ¨æ€å¿«é€Ÿã€‚

  åœ¨äº‘åŸç”Ÿå®‰å…¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¼ºè°ƒåŸºç¡€è®¾æ–½çš„å¯è§‚æµ‹æ€§ï¼Œå¯¹äºèŠ‚ç‚¹ã€å®¹å™¨ã€åº”ç”¨ã€æœåŠ¡ç­‰å„å±‚æ¬¡ç­‰ç³»ç»Ÿæ„æˆå…ƒç´ æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç›‘æ§å…¶è¿è¡ŒçŠ¶æ€è·å–å…¶æ€§èƒ½æŒ‡æ ‡ï¼Œä¹Ÿéœ€è¦å¯¹ä¸€ä¸ªè¿›å…¥é›†ç¾¤çš„è¯·æ±‚è¿›è¡Œè¿½è¸ªï¼Œå¯¹å„ç»„ä»¶äº§ç”Ÿçš„æ—¥è®°ä¿¡æ¯è¿›è¡Œæ”¶é›†æ±‡æ€»ï¼Œæ±‡æ€»å„ä¸ªç»´åº¦çš„æ•°æ®ä¿¡æ¯ï¼Œä¸ºç¼–æ’å¹³å°è¿›è¡Œå†³ç­–ä»¥åŠäº‹ä»¶æº¯æºæä¾›å……è¶³çš„ä¿¡æ¯æ”¯æ’‘ã€‚XDP ç¨‹åºå¯ä»¥ä¸å…¶å®ƒç»„ä»¶ä»¥åŠæ•°æ®æºè¿›è¡Œæ­é…ç»„åˆï¼Œé€šè¿‡å®æ—¶çš„ç›‘æµ‹æŒ‡æ ‡ä»¥åŠè¿è¡ŒçŠ¶æ€æ•°æ®ç»Ÿè®¡ï¼ŒåŠ¨æ€åœ°æ”¹å˜é›†ç¾¤å†…éƒ¨çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ï¼Œæœ€ç»ˆå®ç°æœåŠ¡é›†ç¾¤çš„é«˜å¯ç”¨ã€‚


### XDP Hook

ä½¿ç”¨ LLVM å¯¹å†…æ ¸æ€çš„ XDP ç¨‹åºè¿›è¡Œç¼–è¯‘åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼å°† ELF æ–‡ä»¶ä¸­çš„ BPF å­—èŠ‚ç åŠ è½½è¿›å…¥å†…æ ¸å¹¶æŒ‚è½½è‡³æŒ‡å®šçš„ç½‘ç»œè®¾å¤‡å½“ä¸­ã€‚

- ç¼–å†™ C ç”¨æˆ·æ€ç¨‹åºï¼Œä½¿ç”¨ BPF Loader å°†ç¼–è¯‘åçš„ XDP ELF æ–‡ä»¶åŠ è½½è¿›å…¥å†…æ ¸ä¹‹ä¸­

- é€šè¿‡ `iproute2 ip` æŒ‚è½½ ï¼ˆè¯¥æ–¹å¼æ‰€ä½¿ç”¨çš„ BPF Loader å¹¶ä¸æ˜¯é€šè¿‡ Libbpf åº“å®ç°çš„ï¼Œè¿™æ„å‘³ç€å½“æˆ‘ä»¬å¼€å§‹ä½¿ç”¨ BPF Maps çš„æ—¶å€™å¯èƒ½ä¼šå‡ºç°ä¸å…¼å®¹çš„æƒ…å†µï¼‰ï¼Œä¸‹é¢å°†ç»™å‡ºä¸€æ®µç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ `ip` å·¥å…·å°†ç¼–è¯‘åçš„ ELF æ–‡ä»¶åŠ è½½è¿›å…¥å†…æ ¸ä¹‹ä¸­

  ```bash
  # å‘ lo ç½‘ç»œè®¾å¤‡ä¸Šä»¥ xdpgeneric æ–¹å¼æŒ‚è½½ xdp_pass_kern.o ELF æ–‡ä»¶ä¸­ section ä¸º xdp çš„å­—èŠ‚ç 
  ip link set dev lo xdpgeneric obj xdp_pass_kern.o sec xdp
  ```

  æœ‰äº†æŒ‚è½½çš„æ–¹å¼æˆ‘ä»¬è¿˜éœ€è¦æœ‰æŸ¥çœ‹å’Œå¸è½½ XDP ç¨‹åºçš„æ–¹å¼ï¼Œä¸‹é¢å°†ä»‹ç»ä½¿ç”¨è¯¥å·¥å…·è¿›è¡ŒæŸ¥çœ‹å’Œå¸è½½çš„æ–¹å¼ï¼Œ

  ```bash
  # å±•ç¤º lo ç½‘ç»œè®¾å¤‡çš„ç›¸å…³ä¿¡æ¯
  ip link show dev lo
  # æ–¹å¼ 2
  bpftool net list dev lo
  
  # ä» lo ç½‘ç»œè®¾å¤‡ä¸­å¸è½½ä»¥ xdpgeneric æ–¹å¼æŒ‚è½½çš„ XDP ç¨‹åº
  ip link set dev lo xdpgeneric off
  ```

- Go è¯­è¨€ä½¿ç”¨ libbpfgo åº“åŠ è½½ ELF æ–‡ä»¶ä¸­çš„ XDP ç¨‹åºå­—èŠ‚ç ï¼Œè¿™ä¸ªæ–¹å¼æ˜¯æœ¬äººè®¤ä¸ºæœ€ä¼˜é›…çš„æ–¹å¼

  ```go
  // åŠ è½½ eBPF ç¨‹åºç¼–è¯‘åçš„ ELF æ–‡ä»¶ 	
  bpfModule, err := bpf.NewModuleFromFile("main.bpf.o")
  	if err != nil {
  		fmt.Fprintln(os.Stderr, err)
  		os.Exit(-1)
  	}
  // åŠ è½½å…¶ä¸­çš„ eBPF å¯¹è±¡
  err = bpfModule.BPFLoadObject()
  	if err != nil {
  		fmt.Fprintln(os.Stderr, err)
  		os.Exit(-1)
  	}
  // æå–å…¶ä¸­çš„å†…æ ¸æ€ç¨‹åº "target" æ˜¯è‡ªç¼–å†™çš„ XDP ç¨‹åºå‡½æ•°å
  xdpProg, err := bpfModule.GetProgram("target")
  	if xdpProg == nil {
  		fmt.Fprintln(os.Stderr, err)
  		os.Exit(-1)
  	}
  // æŒ‡å®šéœ€è¦æŒ‚è½½çš„ç½‘ç»œè®¾å¤‡ lo
  _, err = xdpProg.AttachXDP("lo")
  	if err != nil {
  		fmt.Fprintln(os.Stderr, err)
  		os.Exit(-1)
  	}
  ```

åœ¨ä¸Šè¿° Go ç¨‹åºä»£ç æˆ‘ä»¬å¯ä»¥å‘ç° `bpfModule.GetProgram("target")` æŒ‡å®šäº†æˆ‘ä»¬æƒ³è¦ä» ELF æ–‡ä»¶ä¸­åŠ è½½çš„ eBPF ç¨‹åºå¯¹è±¡ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª ELF æ–‡ä»¶å¯ä»¥åŒ…å«å¤šä¸ª XDP ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­é€‰æ‹©æˆ‘ä»¬æ‰€éœ€è¦çš„è¿›è¡ŒåŠ è½½ã€‚è¿™ç§èƒ½åŠ›æ˜¯ libbpfgo å°è£… libbpf å¾—æ¥çš„ï¼Œè€Œ libbpf æ˜¯é€šè¿‡å°è£…ç³»ç»Ÿè°ƒç”¨å¾—åˆ°çš„ã€‚

åœ¨ libbpf ä¸­å†…éƒ¨ä½¿ç”¨ `struct bpf_object` `struct bpf_program` `struct bpf_map` ä¸‰ç±»ç»“æ„ä½“å»ç®¡ç†å’ŒæŠ½è±¡ eBPF ç¨‹åºï¼Œç”¨æˆ·éœ€è¦ä½¿ç”¨ libbpf å¯¹å¤–æš´éœ²çš„ API æ¥å£å»æ“ä½œç›¸å…³çš„æ•°æ®ç»“æ„ã€‚



> XDP ç¨‹åºæ“ä½œæ¨¡å¼ç§ç±»ï¼šåŸç”Ÿæ¨¡å¼  (Native XDP) å¸è½½æ¨¡å¼ (Offloaded XDP) é€šç”¨æ¨¡å¼ (Generic XDP)
>
> Native XDPï¼š
>
> â€‹	è¯¥æ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒXDP çš„ BPF ç¨‹åº åœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºçš„æ—©æœŸæ¥æ”¶è·¯å¾„ä¹‹å¤–ç›´æ¥è¿è¡Œã€‚ä½¿ç”¨è¯¥æ¨¡å¼éœ€è¦ç¡¬ä»¶è®¾å¤‡çš„æ”¯æŒã€‚ä½¿ç”¨ `git grep -l XDP_SETUP_PROG drivers` å‘½ä»¤å¯ä»¥æ£€æŸ¥é©±åŠ¨ç¨‹åºæ˜¯å¦æ”¯æŒæ­¤æ¨¡å¼ã€‚
>
> Offloaded XDPï¼š
>
> â€‹	åœ¨å¸è½½æ¨¡å¼ä¸‹ï¼ŒXDP çš„ BPF ç¨‹åºç›´æ¥å¸è½½åˆ°ç½‘å¡ä¸Šï¼Œè€Œä¸æ˜¯åœ¨ä¸»æœº CPU ä¸Šæ‰§è¡Œã€‚å› æœ¬å°±ä»…æœ‰ç›¸å½“ä½å¼€é”€çš„ XDP ç¨‹åºçš„æ‰§è¡Œä» CPU ä¸Šè½¬ç§»åˆ°ç½‘å¡ä¸Šï¼Œä»è€Œè¿™ç§æ¨¡å¼èƒ½å¤Ÿæ¯”åŸç”Ÿ XDP å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚ä½¿ç”¨è¿™ç§æ“ä½œæ¨¡å¼çš„ XDP ç¨‹åºéœ€è¦å¾—åˆ°ç½‘å¡çš„æ”¯æŒã€‚ä½¿ç”¨ `git grep -l XDP_SETUP_PROG_HW drivers` å¯ä»¥æ£€æŸ¥å“ªäº›ç½‘å¡é©±åŠ¨ç¨‹åºæ”¯æŒ Offloaded æ¨¡å¼ã€‚
>
> Generic XDPï¼š
>
> â€‹	å¯¹äºæ²¡æœ‰æä¾› Offloaded æˆ– Native æ¨¡å¼æ”¯æŒçš„ç½‘å¡è®¾å¤‡æ¥è¯´ï¼Œå†…æ ¸æä¾›äº†ä¸€ä¸ªä½¿ç”¨ XDP é€šç”¨æ¨¡å¼çš„é€‰é¡¹ã€‚ä½¿ç”¨æ­¤æ¨¡å¼ä¸éœ€è¦éœ€è¦ä»»ä½•çš„é©±åŠ¨æ”¯æŒï¼Œå› ä¸ºå…¶è¿è¡Œåœ¨ä¸€ä¸ªç›¸å¯¹äºç½‘ç»œå†…æ ¸æ ˆä¸­ç›¸å¯¹é åçš„ä½ç½®ã€‚å…¶å­˜åœ¨ä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†å¼€å‘äººå‘˜åœ¨ä¸æ”¯æŒä¸Šè¿°ä¸¤ç§æ¨¡å¼çš„ç¯å¢ƒä¸­è¿›è¡Œ XDP ç¨‹åºçš„å¼€å‘ä¸è°ƒè¯•ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼ŒXDP ç¨‹åºçš„è¿è¡Œæ€§èƒ½æ²¡æœ‰å‰ä¸¤è€…é‚£ä¹ˆé«˜æ•ˆï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¨èä½¿ç”¨å‰ä¸¤ç§æ¨¡å¼ã€‚



### XDP ç¨‹åºçš„ç¼–å†™

#### Basic 03 - counting with BPF maps

æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªå…¨å±€ç»“æ„ä½“ `bpf_map_def` å¹¶å¸¦ä¸Š `SEC("maps")` å®æ¥åˆ›å»ºä¸€ä¸ª BPF mapï¼Œ

```c
struct {
	__uint(type, BPF_MAP_TYPE_ARRAY);
	__type(key, __u32);
	__type(value, struct datarec);
	__uint(max_entries, XDP_ACTION_MAX);
} xdp_stats_map SEC(".maps");

struct {
    __uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);
    __type(key, __u32);
    __type(value, struct datarec);
    __uint(max_entries, MAX_ENTRIES);
} xdp_stats_map_percpu SEC(".maps");
```

{{< admonition tip "BPF Maps åˆ›å»º â€”â€” ä»£ç ç¤ºèŒƒ" false >}}
å½“ä½ éœ€è¦åˆ›å»ºæ•°é‡è¾ƒå¤šçš„ BPF Maps æ—¶ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹åˆ›å»ºç¤ºä¾‹æ¥ç®€åŒ–ä½ çš„ä»£ç é€»è¾‘ï¼Œ

```c
#define BPF_MAP(_name, _type, _key_type, _value_type, _max_entries)                                \
    struct {                                                                                       \
        __uint(type, _type);                                                                       \
        __uint(max_entries, _max_entries);                                                         \
        __type(key, _key_type);                                                                    \
        __type(value, _value_type);                                                                \
    } _name SEC(".maps");

#define BPF_HASH(_name, _key_type, _value_type, _max_entries)                                      \
    BPF_MAP(_name, BPF_MAP_TYPE_HASH, _key_type, _value_type, _max_entries)

#define BPF_LRU_HASH(_name, _key_type, _value_type, _max_entries)                                  \
    BPF_MAP(_name, BPF_MAP_TYPE_LRU_HASH, _key_type, _value_type, _max_entries)

BPF_HASH(kconfig_map, u32, u32, 10240);
BPF_HASH(interpreter_map, u32, file_info_t, 10240);      
BPF_HASH(containers_map, u32, u8, 10240);  
```

 ä¸Šè¿°ç¤ºä¾‹ä»£ç æ¥è‡ª [tracee](https://github.com/aquasecurity/tracee)
{{< /admonition >}}

BPF maps æ˜¯é€šç”¨çš„é”®å€¼å¯¹å­˜å‚¨æ–¹å¼ï¼Œåœ¨ä¸Šè¿°å®šä¹‰ä¸­ `__uint(type, BPF_MAP_TYPE_ARRAY)` ç”¨äºæŒ‡å®šç‰¹å®šç±»å‹çš„ BPF mapsï¼ˆè¿™é‡Œç»™å‡ºäº† v5.4 å†…æ ¸ç‰ˆæœ¬ä¸­æ‰€æœ‰çš„ [BPF maps ç±»å‹](https://elixir.bootlin.com/linux/v5.4/source/include/uapi/linux/bpf.h#L115)ï¼‰ï¼Œ`__type(key, __u32)` ç”¨äºæŒ‡å®š Key å¯¹åº”çš„æ•°æ®ç±»å‹ï¼Œ`__type(value, struct datarec)` ç”¨äºæŒ‡å®š Value å¯¹åº”çš„æ•°æ®ç±»å‹ï¼Œ`__uint(max_entries, XDP_ACTION_MAX)` ç”¨äºæŒ‡å®šå¯å­˜æ”¾çš„æœ€å¤§å…ƒç´ ä¸ªæ•°ã€‚

ä½¿ç”¨ `bpf_object_find_map_by_name()` å‡½æ•°å¯ä»¥é€šè¿‡ BPF maps çš„åå­—æ‰¾åˆ°å…¶å¯¹åº”çš„ `bpf_map` å¯¹è±¡ï¼Œé€šè¿‡ `bpf_map_fd()` å‡½æ•°å¯ä»¥è·å¾— map çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œlibbpf åº“ä¸­æä¾›äº†ä¸€ä¸ªå‡½æ•°`bpf_object__find_map_fd_by_name()` ç”¨äºç›´æ¥å®Œæˆä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤ã€‚

{{< admonition type=tip title="eBPF Maps ç‰¹æ€§" open=false >}}
æ‰€æœ‰å¤„äºå†…æ ¸æ€çš„ BPF ç¨‹åºä»¥åŠç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºéƒ½èƒ½å¤Ÿè®¿é—® BPF Mapsã€‚
{{< /admonition >}}

åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•° `bpf_map_lookup_elem()` åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¯»å– BPF Maps ä¸­çš„å†…å®¹ã€‚



åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«å®šä¹‰äº†ä¸¤ç§ä¸åŒç±»å‹çš„ BPF Mapsï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ `BPF_MAP_TYPE_ARRAY` ä¸ `BPF_MAP_TYPE_PERCPU_ ARRAY` ï¼Œå®ƒä»¬ä¸¤è€…ä¹‹é—´æœ€å¤§çš„åŒºåˆ« **ã€å¯¹æŒæœ‰çš„æ•°æ®å¯¹è±¡è¿›è¡Œæ“ä½œæ˜¯å¦éœ€è¦åŠ é”ã€‘** ï¼Œå¯¹äºå‰è€…æ¥è¯´å¤šä¸ªæ•°æ®æ“ä½œä¸»ä½“å¯¹ä¸€ç‰‡å…±äº«å†…å­˜ç©ºé—´è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥åœ¨è¿™ç‰‡å†…å­˜ç©ºé—´ä¹‹ä¸Šè¿›è¡Œæ“ä½œæ—¶éœ€è¦æŒæœ‰é”ï¼ˆæ“ä½œéœ€è¦æ˜¯åŸå­çš„ï¼‰ï¼Œè€Œå¯¹äºåè€…æ¥è¯´ï¼Œç”±äºå„æ•°æ®æ“ä½œä¸»ä½“ç‹¬æœ‰ä¸€ç‰‡è‡ªç”¨çš„å†…å­˜ç©ºé—´ï¼Œä¾¿ä¸å­˜åœ¨äº†ä¸´ç•ŒåŒºï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿™ç‰‡åŒºåŸŸä¸Šè¿›è¡Œè¯»å†™ã€‚**ä¸è¿‡ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´ä»£ç ä¸­çš„æ“ä½œå¯èƒ½ä¼šæœ‰äº›è®¸ä¸åŒï¼Œè¿™æ˜¯ç”±äºæ•°æ®è¢«å„ CPU æ‰€æŒæœ‰ï¼Œè¦æƒ³è·å–å®Œæ•´çš„æ•°æ®éœ€è¦éå†æ‰€æœ‰ CPU æŒæœ‰çš„ Map å¯¹è±¡**ã€‚æ³¨æ„åˆ°è€ƒè™‘ç¡¬ä»¶å¹³å°å¯èƒ½ä¼šæ”¯æŒ CPU çƒ­æ’æ‹”ï¼Œæ‰€ä»¥ Linux Kernel åœ¨åˆå§‹åŒ–æ—¶ä¼šä¸ºè¿™äº›æ½œåœ¨çš„å¯èƒ½èƒ½å¤Ÿä¸Šçº¿çš„ CPU åˆå§‹åŒ–ç›¸åº”çš„ Bufferï¼Œåˆ†é…ç›¸åº”çš„ CPU IDã€‚è‹¥è¦æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸­æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„ CPU æ•°é‡ï¼Œå¯ä»¥åœ¨ root æƒé™ä¸‹æŸ¥çœ‹ `/sys/devices/system/cpu/possible` æ–‡ä»¶æ¥è·å–å†…æ ¸è®¤ä¸ºå¯èƒ½ä¼šå­˜åœ¨çš„ CPU æ•°ç›®ï¼Œä»è€Œå½“æˆ‘ä»¬è¯»å– per-cpu buffer æ—¶ï¼Œéœ€è¦è¯»å–è¿™äº›æ‰€æœ‰å¯èƒ½å­˜åœ¨ CPU çš„ bufferã€‚æœ‰å…³ `num_possible_cpus` çš„è®¨è®ºå¯ä»¥å‚è€ƒ[æ­¤å¤„](https://github.com/libbpf/libbpf/issues/383)ã€‚

{{< admonition tip "eBPF ç¨‹åºç¼–å†™æŒ‡å—" false >}}
åœ¨ç¼–å†™ BPF ç¨‹åºæ—¶ï¼Œé‡åˆ°ä¸ç†Ÿæ‚‰çš„å‡½æ•°æˆ–è€…ç”¨æ³•ï¼Œå¯ä»¥æŸ¥çœ‹ bpf-helpersã€‚é€šè¿‡ `man bpf-helpers` å‘½ä»¤å¯ä»¥æŸ¥çœ‹å„å‡½æ•°ç›¸å…³å…¥å‚ã€ä½¿ç”¨æ–¹æ³•æè¿°ä»¥åŠå‡½æ•°çš„è¿”å›å€¼ã€‚
{{< /admonition >}}




æˆ‘åœ¨æœ¬è¯¾ç¨‹ä¸­ä½¿ç”¨ Go è¯­è¨€ç¼–å†™å¯¹åº”çš„ç”¨æˆ·æ€ä»£ç ï¼Œä¸»è¦ä½¿ç”¨åˆ°äº† `github.com/aquasecurity/libbpfgo` [è¿™ä¸ªåº“](https://github.com/aquasecurity/libbpfgo)ï¼Œå…¶ä¸­é‡åˆ°äº†ä¸€äº›å‘ï¼ˆä¹Ÿè®¸æ˜¯æˆ‘ä¸ä¼šç”¨ ğŸ˜…ï¼‰

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `bpfModule.GetMap("xdp_stats_map_percpu")` è·å– BPF Maps å¯¹è±¡ï¼Œæ­¤åä¾¿å¯ä»¥å°†å…¶å¸è½½åˆ°æŒ‡å®šçš„ NIC ä¸Šï¼Œç›‘å¬è¯¥ç½‘å¡ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ã€‚æ¥ç€ä½¿ç”¨ ` bpfMap.GetValu e(unsafe.Pointer(&XDP_PASS))` æˆ‘ä»¬ä¾¿å¯ä»¥è·å– Map å¯¹åº” Key æ‰€å­˜å‚¨çš„æ•°æ®ã€‚ä½†æˆ‘å°è¯•ä» `BPF_MAP_TYPE_PERCPU_ARRAY` ç±»å‹çš„ Map ä¸­è·å–æ•°æ®æ—¶å´æ²¡æœ‰å¾—åˆ°é¢„æœŸä¸­çš„ç»“æœã€‚æˆ‘éšå³æŸ¥é˜…äº† `(*BPFMap) GetValue(unsafe.Pointer)` å‡½æ•°çš„ç›¸å…³å®ç°ï¼Œ

```go
// GetValue takes a pointer to the key which is stored in the map.
// It returns the associated value as a slice of bytes.
// All basic types, and structs are supported as keys.
//
// NOTE: Slices and arrays are also supported but special care
// should be taken as to take a reference to the first element
// in the slice or array instead of the slice/array itself, as to
// avoid undefined behavior.
func (b *BPFMap) GetValue(key unsafe.Pointer) ([]byte, error) {
	value := make([]byte, b.ValueSize())
	valuePtr := unsafe.Pointer(&value[0])

	ret, errC := C.bpf_map_lookup_elem(b.fd, key, valuePtr)
	if ret != 0 {
		return nil, fmt.Errorf("failed to lookup value %v in map %s: %w", key, b.name, errC)
	}
	return value, nil
}
```

å¯ä»¥çœ‹åˆ°å…¶ä¸­ value åˆ†é…çš„å†…å­˜ç©ºé—´åªæœ‰ `b.ValueSize()` ä¹Ÿå³å•ä¸ª Value æ•°æ®ç»“æ„çš„ç©ºé—´ï¼Œä½†å½“æˆ‘ä»¬ä½¿ç”¨ `BPF_MAP_TYPE_PERCPU_ARRAY` Map ç±»å‹æ—¶ï¼Œ`bpf_map_lookup_elem` è¿”å›çš„æ˜¯æ‰€æœ‰ CPU å„è‡ªæŒæœ‰çš„ Map å¯¹è±¡ä¸­çš„æ•°æ®ï¼Œ

```c
	struct datarec values[nr_cpus]; // sizeof(struct datarec) * nr_cpus
	int i;

	if ((bpf_map_lookup_elem(fd, &key, values)) != 0) {
		fprintf(stderr,
			"ERR: bpf_map_lookup_elem failed key:0x%X\n", key);
		return;
	}

	for (i = 0; i < nr_cpus; i++) {
		sum_pkts  += values[i].rx_packets;
		sum_bytes += values[i].rx_bytes;
	}
```

`bpf_map_*` ç³»åˆ—å‡½æ•°éƒ½æ˜¯é€šè¿‡ `bpf()` ç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼Œå…·ä½“å®ç°[å‚è€ƒæ­¤å¤„](https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L371)ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ `bpf` ç³»ç»Ÿè°ƒç”¨æ‰‹å†Œã€‚

<center>    <img style="border-radius: 0.3125em;    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08); zoom:67%;"     src="https://image.p1nant0m.xyz/bpf_basic03.png">    <br>    <div style="color:orange; border-bottom: 1px solid #d9d9d9;    display: inline-block;    color: #999;    padding: 2px;">ç¤ºä¾‹ä»£ç è¿è¡Œè¾“å‡º</div> </center>

ç§‰ç€æœ‰é—®é¢˜å°±è¦æš´éœ²å‡ºæ¥çš„æƒ³æ³•ï¼Œæˆ‘å» libbpfgo ä»“åº“ä¸‹æäº†ä¸€ä¸ª [issues](https://github.com/aquasecurity/libbpfgo/issues/191)ï¼Œæœ€ç»ˆä¹Ÿå¾—åˆ°äº†è§£ç­”ã€‚



### TCP åè®®æŠ¥æ–‡ç»“æ„

[RFC 793](https://datatracker.ietf.org/doc/html/rfc793)

```bash
                    0                   1                   2                   3
                    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |          Source Port          |       Destination Port        |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                        Sequence Number                        |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                    Acknowledgment Number                      |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |  Data |           |U|A|P|R|S|F|                               |
                   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
                   |       |           |G|K|H|T|N|N|                               |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |           Checksum            |         Urgent Pointer        |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                    Options                    |    Padding    |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                             data                              |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                                            TCP Header Format
```

ç›¸å…³å­—æ®µå«ä¹‰ç½‘ç»œä¸Šå·²ç»æœ‰éå¸¸å¤šè¯¦ç»†çš„è¯´æ˜ï¼Œåœ¨æœ¬æ–‡ä¸­ä¾¿ä¸å†èµ˜è¿°ã€‚



### IP åè®®æŠ¥æ–‡ç»“æ„

[RFC 791](https://datatracker.ietf.org/doc/html/rfc791)

```bash
                    0                   1                   2                   3
                    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |Version|  IHL  |Type of Service|          Total Length         |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |         Identification        |Flags|      Fragment Offset    |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |  Time to Live |    Protocol   |         Header Checksum       |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                       Source Address                          |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                    Destination Address                        |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   |                    Options                    |    Padding    |
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                                    Example Internet Datagram Header
```

ç›¸å…³å­—æ®µå«ä¹‰ç½‘ç»œä¸Šå·²ç»æœ‰éå¸¸å¤šè¯¦ç»†çš„è¯´æ˜ï¼Œåœ¨æœ¬æ–‡ä¸­ä¾¿ä¸å†èµ˜è¿°ã€‚

### References

1. [Github repo](https://github.com/xdp-project/xdp-tutorial) for Learning XDP Programming 
2. [Cilium BPF reference guide](https://cilium.readthedocs.io/en/latest/bpf/) for building industrial application with BPF
3. General Introduction to XDP in [the academic paper](https://github.com/xdp-project/xdp-paper/blob/master/xdp-the-express-data-path.pdf) or [the presentation](https://github.com/xdp-project/xdp-paper/blob/master/xdp-presentation.pdf).  
4. [Linux å†…æ ¸è§‚æµ‹æŠ€æœ¯ BPF](https://item.jd.com/12939760.html)
5. æå®¢æ—¶é—´è¯¾ç¨‹ï¼Œå€ªé¹é£è€å¸ˆçš„ eBPF æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜
6. [Cilium: eBPF-based Networking, Security, and Observability](https://github.com/cilium/cilium)
7. [tracee: Linux Runtime Security and Forensics using eBPF](https://github.com/aquasecurity/tracee)
8. [ebpf official](https://ebpf.io/zh-cn/)
