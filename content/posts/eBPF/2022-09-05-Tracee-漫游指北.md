---
title: "Tracee æ¼«æ¸¸æŒ‡åŒ—"
subtitle:   "Tracee ä½¿ç”¨ eBPF æ„å»ºçš„ Linux è¿è¡Œæ—¶å®‰å…¨ä¸å–è¯é¡¹ç›®"
date:       2022-09-05 09:29:17
author:     "p1nant0m"
lightgallery: true
tags: 
    - eBPF
    - OpenSource Project
    - Security Issues
---

![header_](https://cdn.jsdelivr.net/gh/wgblikeW/blog-imgs/header_opensource.png)

é¡¹ç›®ä»“åº“åœ°å€ï¼š[https://github.com/aquasecurity/tracee](https://github.com/aquasecurity/tracee)

### å‰è¨€

è¿™æ®µæ—¶é—´å‡†å¤‡çœ‹çœ‹å¼€æºä¸–ç•Œä¸­å®‰å…¨å¹³å°å±‚é¢çš„äº§å“ä»¥åŠä¸»æœºå®‰å…¨ã€è¿è¡Œæ—¶å®‰å…¨ç­‰æŠ€æœ¯ç°é˜¶æ®µä¸šç•Œçš„å®ç°ï¼Œä¸ºå³å°†åˆ°æ¥çš„æ¯•ä¸šè®¾è®¡æˆ–è®ºæ–‡ä½œå‡†å¤‡ã€‚eBPF æŠ€æœ¯ä»æ˜¯ç›®å‰æˆ‘æœ€ä¸ºçœ‹å¥½çš„äº‘åŸç”Ÿä¸–ç•Œå¯è§‚æµ‹æ€§ã€ç½‘ç»œä»¥åŠå®‰å…¨é¢†åŸŸæœ€ä¸ºå¼ºæœ‰åŠ›çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼Œè®¸å¤šè€ç‰Œçš„äº‘åŸç”Ÿå¼€æºé¡¹ç›®ä¹Ÿéƒ½åŸºäº eBPF æå‡ºäº†ä¸€ç³»åˆ— proposals ç”¨äºæ”¹è¿›äº§å“æ€§èƒ½ï¼Œå¢å¼ºåŠŸèƒ½æ€§ã€‚åŸºäº eBPF æŠ€æœ¯æ„å»ºçš„ [Cilium](https://cilium.io/) ä¹Ÿäº **2021 å¹´ 10 æœˆ 13 æ—¥** æˆä¸ºäº† CNCF çš„å­µåŒ–é¡¹ç›®ï¼Œå—åˆ°å¼€æºç¤¾åŒºè¾ƒå¤§çš„å…³æ³¨ã€‚

ä¹Ÿè®¸ä¼šå†™ä¸€ç³»åˆ—æ–‡ç« æ¥ä»‹ç»ç›¸å…³çš„å¼€æºé¡¹ç›®åŠå…¶äº§å“è®¾è®¡æ€è·¯ï¼Œä¸»è¦çš„è§’åº¦åº”è¯¥æ˜¯ä»åŠŸèƒ½æ€§ã€æ¶æ„è®¾è®¡ã€ä»¥åŠæŠ€æœ¯é€‰å‹å‡ºå‘æ¢ç©¶è¿™äº›ä¼˜ç§€å¼€æºä½œå“çš„åº•å±‚è®¾è®¡é€»è¾‘ï¼Œä»ä¸­çª¥æ¢ç›®å‰ä¸šç•ŒæŠ€æœ¯ã€æ¶æ„å‘å±•çš„è¶‹åŠ¿ã€‚è‡³äºç¼–ç å±‚é¢çš„ç»†èŠ‚å¯èƒ½åªä¼šç¨å¾®æä¸€ææœ‰æ„æ€çš„è®¾è®¡ï¼Œé‡å¿ƒè¿˜æ˜¯ä¼šæ”¾åœ¨æŠ€æœ¯åº”ç”¨äºäº§å“ä¸Šå¯¹æŸä¸€æ½å­é—®é¢˜çš„é€šç”¨è§£å†³æ€è·¯ã€‚

ä»ç›®å‰æ”¶é›†åˆ°çš„ä¿¡æ¯æ¥çœ‹ï¼Œç›¸å…³å¼€æºé¡¹ç›®æœ‰ï¼Œ

- [x] Tracee
- [ ] Tetragon
- [ ] Elkeid
- [ ] Cilium

### Tracee é¡¹ç›®ç®€ä»‹

Tracee æ˜¯ä¸€ä¸ªä½¿ç”¨ eBPF æŠ€æœ¯æ„å»ºçš„è¿è¡Œæ—¶å®‰å…¨ä¸å–è¯é¡¹ç›®ï¼Œå…¶ä¸»è¦ç”±ä»¥ä¸‹ä¸¤éƒ¨åˆ†ç»„ä»¶æ„æˆï¼Œ

**ï¼ˆ1ï¼‰** Tracee-eBPF ä½¿ç”¨ eBPF æŠ€æœ¯å‘å†…æ ¸æ’å…¥æ¢é’ˆæ•è·å†…æ ¸å±‚é¢å‘ç”Ÿçš„äº‹ä»¶ï¼Œå¹¶å°†è¿™äº›å—åˆ°ç”¨æˆ·å…³æ³¨çš„å†…æ ¸äº‹ä»¶ä¿¡æ¯é€šè¿‡ BPF Maps ä¼ é€’è‡³ç”¨æˆ·æ€å½¢æˆäº‹ä»¶æµï¼Œå‘ŠçŸ¥ç”¨æˆ·å½“å‰å†…æ ¸å±‚é¢æ­£åœ¨å‘ç”Ÿä»€ä¹ˆï¼Œæ˜¯æ•´ä¸ªé¡¹ç›®çš„æ•°æ®æ¥æºã€‚

**ï¼ˆ2ï¼‰** Tracee-Rules æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å®‰å…¨æ£€æµ‹å¼•æ“ï¼Œå…¶è´Ÿè´£åˆ†æ Tracee-eBPF æäº¤ä¸Šæ¥çš„äº‹ä»¶æµï¼Œä»è€Œåˆ¤æ–­åœ¨å½“å‰å®‰å…¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ˜¯å¦æœ‰å¼‚å¸¸è¡Œä¸ºå‘ç”Ÿï¼Œé€šè¿‡è‡ªå®šä¹‰æˆ–å†…ç½®çš„è§„åˆ™ï¼ˆSignature/Rules) äº§ç”Ÿå®æ—¶å‘Šè­¦ï¼Œä»¥å‘ŠçŸ¥ç®¡ç†å‘˜æ½œåœ¨çš„å®‰å…¨å¨èƒã€‚

### Tracee QuickStart

æ ¹æ® [å®˜æ–¹æ–‡æ¡£](https://aquasecurity.github.io/tracee/v0.8.1/#quickstart)ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Docker å¿«é€Ÿéƒ¨ç½² Tracee é¡¹ç›®ï¼Œæä¾›å†…æ ¸å±‚é¢çš„å¯è§‚æµ‹æ€§ã€‚ä¸è¿‡ï¼Œåœ¨éƒ¨ç½²ä¹‹å‰æˆ‘ä»¬éœ€è¦ç¡®è®¤å½“å‰è¿è¡Œçš„ Linux ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬æ˜¯å¦æ”¯æŒ eBPF ç‰¹æ€§ä»¥åŠæ˜¯å¦å­˜åœ¨ eBPF ç¨‹åºè¿è¡Œéœ€è¦ç¡®å®šçš„å†…æ ¸æ•°æ®ç»“æ„æ–‡ä»¶ï¼Œç›¸å…³è¯¦æƒ…å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„ [Prerequisites](https://aquasecurity.github.io/tracee/v0.8.1/installing/prerequisites/). 

åœ¨ä¸€åˆ‡éƒ½å‡†å¤‡å¦¥å½“ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨ Docker éƒ¨ç½² Tracee é¡¹ç›®äº†ï¼Œä¸è¿‡ä¸ºäº†æ–¹ä¾¿åç»­ä»‹ç» Tracee çš„ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé€‰æ‹©ä½¿ç”¨ [åˆ†å‘çš„ Binary ç‰ˆæœ¬](https://github.com/aquasecurity/tracee/releases) æ¥è¿›è¡Œæ¼”ç¤ºã€‚

åœ¨å®˜æ–¹é¡¹ç›® repo Releases é¡µé¢ä¸­ä¸‹è½½æœ€æ–°çš„é¡¹ç›®æ„å»ºç‰ˆæœ¬ï¼ˆç¬”è€…å½“æ—¶ä¸‹è½½çš„ç‰ˆæœ¬æ˜¯ v0.8.1ï¼‰ï¼Œå¹¶å°†å‹ç¼©åŒ…ä¸­çš„å†…å®¹è§£å‹åˆ°ä½•æ—¶çš„ä½ç½®ï¼Œæœ€ç»ˆå®éªŒç¯å¢ƒçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼Œ

```bash
.
â”œâ”€â”€ rules
â”‚Â Â  â”œâ”€â”€ anti_debugging_ptraceme.rego
â”‚Â Â  â”œâ”€â”€ cgroup_release_agent_modification.rego
â”‚Â Â  â”œâ”€â”€ code_injection.rego
â”‚Â Â  â”œâ”€â”€ disk_mount.rego
â”‚Â Â  â”œâ”€â”€ dropped_executable.rego
â”‚Â Â  â”œâ”€â”€ dynamic_code_loading.rego
â”‚Â Â  â”œâ”€â”€ fileless_execution.rego
â”‚Â Â  â”œâ”€â”€ helpers.rego
â”‚Â Â  â”œâ”€â”€ illegitimate_shell.rego
â”‚Â Â  â”œâ”€â”€ kernel_module_loading.rego
â”‚Â Â  â”œâ”€â”€ kubernetes_certificate_theft_attempt.rego
â”‚Â Â  â”œâ”€â”€ ld_preload.rego
â”‚Â Â  â””â”€â”€ syscall_table_hooking.rego
â”œâ”€â”€ tracee.bpf.core.o
â”œâ”€â”€ tracee-ebpf
â””â”€â”€ tracee-rules
```

`rules` æ–‡ä»¶å¤¹ä¸­å­˜æ”¾çš„æ˜¯ tracee-rules çš„å†…ç½®è§„åˆ™ï¼Œ`tracee.bpf.core.o` æ˜¯ç»è¿‡ç¼–è¯‘åçš„ä¸€ç³»åˆ— eBPF æ¢é’ˆç¨‹åºï¼Œ`tracee-ebpf` ä¸ `tracee-rules` ä¾¿æ˜¯æˆ‘ä»¬ä¸Šè¿°æåˆ°çš„ tracee é¡¹ç›®ä¸­çš„ä¸¤å¤§ç»„ä»¶ã€‚

æ‰§è¡Œä¸‹è¿°å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ tracee-ebpf ç¨‹åºè¿›è¡Œå†…æ ¸äº‹ä»¶æ•è·å¹¶å°†ç›¸å…³çš„ä¿¡æ¯é€šè¿‡ pipe é‡å®šå‘è‡³ tracee-rules çš„è¾“å…¥æµä¸­ï¼Œtracee-rules é€šè¿‡å†…ç½®çš„è§„åˆ™å¯¹ç›¸å…³äº‹ä»¶æµè¿›è¡Œç ”åˆ¤åˆ†æï¼Œæœ€ç»ˆæ•è·å¼‚å¸¸äº‹ä»¶çš„æ‰§è¡Œï¼Œåœ¨æ ‡å‡†è¾“å‡ºæµä¸­äº§ç”Ÿå‘Šè­¦ï¼Œ

```bash
sudo ./tracee-ebpf --output format:gob --output option:parse-arguments | ./tracee-rules --input-tracee file:stdin --input-tracee format:gob
```

æˆ‘ä»¬å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ª Terminal ä¸­æ‰§è¡Œ `strace ls` å‘½ä»¤ï¼Œè·Ÿè¸ªæ‰§è¡Œ `ls` ç¨‹åºæ—¶è¿›è¡Œçš„ç³»ç»Ÿè°ƒç”¨ä»¥åŠå…¶ä¼ å…¥çš„ç›¸å…³å‚æ•°ã€‚å½“æˆ‘ä»¬å†æ¬¡å›åˆ°åŸå…ˆçš„ Terminal å¤„æ—¶ï¼Œå¯ä»¥å‘ç°åœ¨æ ‡å‡†è¾“å‡ºæµä¸­äº§ç”Ÿäº†ç›¸å…³çš„å‘Šè­¦ï¼Œ

```bash
*** Detection ***
Time: 2022-09-07T06:25:10Z
Signature ID: TRC-2
Signature: Anti-Debugging
Data: map[]
Command: strace
Hostname:  {my-hostname}
```

ä¸è¯¥å‘Šè­¦ç›¸å…³çš„æè¿°ä¸ºï¼Œ

> Process uses anti-debugging technique to block debugger

åˆ°è¿™æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•ç®€å•åœ°ä½¿ç”¨ Tracee è¿›è¡Œå†…æ ¸äº‹ä»¶ç›‘æµ‹ä»¥åŠå¼‚å¸¸è¡Œä¸ºå‘Šè­¦çš„åŠŸèƒ½æ¼”ç¤ºã€‚åé¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šç»§ç»­å‘æ˜ tracee-ebpf çš„å…¶å®ƒåŠŸèƒ½ï¼Œåœ¨ç©è€ä¹‹ä¸­å­¦ä¹ è¯¥é¡¹ç›®çš„ç²¾é«“ï¼Œä½“ä¼š eBPF æŠ€æœ¯å¸¦æ¥çš„å¼ºå¤§åº•å±‚è§‚æµ‹ä»¥åŠæ“æ§èƒ½åŠ›ã€‚

### Tracee-ebpf ç»„ä»¶åˆä½“éªŒ

tracee-ebpf åœ¨ Tracee é¡¹ç›®ä¸­æ‰®æ¼”äº†ä¿¡æ¯æ”¶é›†è€…çš„è§’è‰²ï¼Œé€šè¿‡å‘å€¼å¾—å…³æ³¨çš„å†…æ ¸å‡½æ•°æˆ–äº‹ä»¶ä¸­æ’å…¥é¢„å®šä¹‰çš„æ¢é’ˆï¼Œæ”¶é›†ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶æœ€ç»ˆé€šè¿‡ BPF Maps å°†ä¿¡æ¯æ±‡æ€»è‡³ç”¨æˆ·æ€ Go ç¨‹åºï¼Œä¸ºç”¨æˆ·å±•ç¤ºäº†å†…æ ¸ä¸–ç•Œå‘ç”Ÿçš„å›¾æ™¯ã€‚

ä¸‹å›¾å±•ç¤ºäº†æ•´ä¸ª [Tracee é¡¹ç›®çš„æ¶æ„](https://aquasecurity.github.io/tracee/v0.8.1/architecture/),

{{< image src="https://aquasecurity.github.io/tracee/v0.8.1/images/architecture.png" caption="Tracee é¡¹ç›®æ¶æ„å›¾" src_s="https://aquasecurity.github.io/tracee/v0.8.1/images/architecture.png" src_l="https://aquasecurity.github.io/tracee/v0.8.1/images/architecture.png" >}}

å…¶ä¸­ï¼Œå·¦ä¸Šè§’éƒ¨åˆ†ä¾¿æ˜¯ tracee-ebpf åœ¨é¡¹ç›®ä¸­çš„ä½ç½®ï¼Œè´Ÿè´£å†…æ ¸äº‹ä»¶çš„é‡‡é›†ä»¥åŠé€šè¿‡ BPF Maps å°†ç›¸å…³çš„ä¿¡æ¯ä»å†…æ ¸æ€ä¸­ä¼ å‡ºåˆ°ç”¨æˆ·æ€ã€‚

{{< admonition type=note title="ğŸŒŸ Starpoint" open=false >}}

Tracee é¡¹ç›®ä¸­å°†ä¿¡æ¯æ”¶é›†çš„æ¨¡å—ä¸äº‹ä»¶åˆ†æç ”åˆ¤çš„æ¨¡å—è¿›è¡Œäº†è§£è€¦åˆ†ç¦»ï¼Œè¿™ä¹Ÿæ˜¯å¤§å¤šæ˜¯å®‰å…¨å¹³å°é¡¹ç›®çš„æ¶æ„æ€è·¯ã€‚

ä¸€æ•´ä¸ªå¤§çš„å®‰å…¨ä½“ç³»éœ€è¦ç”±å¤šä¸ªå…·æœ‰ä¸åŒèŒè´£çš„æ¨¡å—å…±åŒå·¥ä½œæ¥è¿›è¡Œæ„å»ºï¼Œè¿™å…¶ä¸­åˆæ— å¤–ä¹æœ‰è¿™ä¹ˆå‡ ä¸ªæŠ½è±¡çš„åŠŸèƒ½ç‚¹ï¼ŒåŒ…æ‹¬ï¼Œ

- ï¼ˆ1ï¼‰ç”±æŸäº›ä¸»ä½“çš„è¡Œä¸ºå¯¼è‡´çš„ä¸€ç³»åˆ—äº‹ä»¶çš„äº§ç”Ÿï¼Œè¿™äº›äº‹ä»¶å¯èƒ½åˆ†æ•£äºç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†ï¼Œå‘ç”Ÿçš„æ—¶é—´ç‚¹ä¹Ÿå¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä½†ä»–ä»¬éƒ½æ˜¯ç”±åŒä¸€ä¸ªå› å¯¼è‡´çš„ã€‚

- ï¼ˆ2ï¼‰ä¸€ä¸ªæ”¶é›†çš„æ–¹æ³•ï¼Œå°†æ¸¸ç¦»äºç³»ç»Ÿå„å¤„ï¼ˆæ—¶é—´å’Œç©ºé—´ä¸Šçš„ï¼‰çš„äº‹ä»¶è¿›è¡Œæ”¶é›†ã€å…³è”ã€èšåˆï¼Œæˆä¸ºå…·æœ‰é«˜åº¦ä¸Šä¸‹æ–‡è¯­ä¹‰ä¿¡æ¯çš„èšåˆä½“ã€‚

- ï¼ˆ3ï¼‰ä¸€ä¸ªè¿›è¡Œåˆ†æçš„æ–¹æ³•ï¼Œæœ‰äº†ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„æ£€æµ‹æ–¹æ³•æ¥è¯†åˆ«å…¶ä¸­åç¦»ç³»ç»ŸåŸºå‡†çš„è¡Œä¸ºäº‹ä»¶ï¼Œé€šä¿—çš„æ¥è¯´å°±æ˜¯å¼‚å¸¸äº‹ä»¶ã€‚

- ï¼ˆ4ï¼‰æ ¹æ®æ£€å‡ºçš„å¼‚å¸¸äº‹ä»¶ä»¥åŠå½“å‰ç³»ç»Ÿçš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œå®šä¹‰å¨èƒåº¦ç­‰çº§ä»¥åŠç›¸åº”çš„è¡Œä¸ºåŠ¨ä½œï¼ŒåŒ¹é…å®‰å…¨ç­–ç•¥ã€‚

- ï¼ˆ5ï¼‰å¯¹è¿›è¡Œå¼‚å¸¸æ“ä½œçš„è¡Œä¸ºä¸»ä½“è¿›è¡Œå°å µæˆ–è¯±æ•ï¼Œé€šè¿‡é¢„å…ˆå®šä¹‰çš„é€šçŸ¥æ¸ é“å‘ŠçŸ¥ç›¸å…³è´£ä»»äººï¼Œæœ€ç»ˆä»¥æ±‚å®ç°å®‰å…¨äº‹ä»¶å“åº”å¤„ç½®é—­ç¯ã€‚

ä¸Šè¿°æ¯ä¸€é¡¹åŠŸèƒ½ç‚¹éƒ½æœ‰è¶³å¤Ÿçš„æ·±åº¦å¯ä»¥è¿›è¡Œç ”ç©¶å‘æ˜ã€‚ç›®å‰æ²¡æœ‰æ¥è¯´è¿˜æ²¡æœ‰å‡ºç°ä¸€å®¶ç‹¬å¤§çš„åœºé¢ï¼Œå„å®‰å…¨å‚å•†ä¹Ÿéƒ½åœ¨ç§¯æå¸ƒå±€äº‘åŸç”Ÿå®‰å…¨ï¼Œé€‚åº”è¿™ç§æ•æ·è½»é‡çš„å®‰å…¨ä½“ç³»å»ºè®¾æ€è·¯ã€‚

{{< /admonition >}}

**âœ¨ tracee-ebpf å‘½ä»¤è¡Œå·¥å…·ä¸»è¦åŠŸèƒ½ä»‹ç»**

tracee-ebpf ä¸»è¦çš„å·¥ä½œä¸ºï¼šï¼ˆ1ï¼‰å°†é¢„å…ˆç¼–è¯‘å¥½çš„ eBPF ç¨‹åºåŠ è½½è¿›å…¥å†…æ ¸ï¼Œå¯¹å†…æ ¸äº‹ä»¶è¿›è¡Œè§‚æµ‹ï¼›ï¼ˆ2ï¼‰ä»å„ç§ç±»å‹çš„ BPF Maps ä¸­å–å‡ºäº‹ä»¶ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å°†æ•°æ®æ±‡æ€»è¾“å‡ºã€‚

tracee-ebpf ç›®å‰æä¾›äº†ä¸€äº›è¾ƒä¸ºç®€æ˜“çš„ Filters ç”¨äºä»æµ·é‡çš„å†…æ ¸äº‹ä»¶ä¸­æŒ‘é€‰å‡ºç”¨æˆ·å…³å¿ƒçš„é‚£äº›äº‹ä»¶ä»¥åŠä¸€äº›æ•æ„Ÿçš„å…¥å‚ã€‚å¹¶ä¸”ï¼Œtracee-ebpf å‘ Prometheus æš´éœ²äº† Metrics é‡‡é›†æ¥å£ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦éœ€è¦è¿™äº›å¤–éƒ¨åŠŸèƒ½ï¼Œè¿™éƒ½å¯ä»¥é€šè¿‡å‘ tracee-ebpf CLI ä¼ å…¥ç›¸å…³å‚æ•°æ¥å†³å®šã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯ä»¥è¿½è¸ªä»¥ `zsh` ä¸ºè¿›ç¨‹åçš„ `execve` çš„äº‹ä»¶ï¼Œ

```bash
sudo ./tracee-ebpf --trace comm=zsh --trace event=execve
```

åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸Šéšä¾¿æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œå†å›åˆ°åŸç»ˆç«¯ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹è¾“å‡ºç»“æœï¼Œ

```bash
TIME             UID    COMM             PID     TID     RET              EVENT                ARGS
17:03:59:874600  1000   zsh              12388   12388   0                execve               pathname: /usr/bin/git, argv: [git rev-parse --git-dir]
17:04:01:888219  1000   zsh              12391   12391   0                execve               pathname: /usr/bin/git, argv: [clear]
```

æ ¹æ®éœ€è¦ï¼Œæˆ‘ä»¬è¿˜èƒ½å¤ŸæŒ‡å®šäº‹ä»¶è¾“å‡ºçš„æ ¼å¼ä»¥åŠå°†äº‹ä»¶æµè¾“å‡ºè‡³æ–‡ä»¶ä¸­ï¼Œè¿›è¡Œæ›´åŠ å¤æ‚çš„äº‹ä»¶è¿‡æ»¤ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œå‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œå®è·µã€‚

### Tracee-rules ç»„ä»¶åˆä½“éªŒ

tracee-rules æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å®‰å…¨æ£€æµ‹å¼•æ“ï¼Œç”¨äºä»æ•°æ®æºä¸­ï¼ˆç›®å‰ä»…æ”¯æŒ tracee-ebpfï¼‰åˆ†ææ˜¯å¦å­˜åœ¨äºè§„åˆ™ï¼ˆSignaturesï¼‰åŒ¹é…çš„äº‹ä»¶è¡Œä¸ºï¼Œè‹¥å‘ç°äº†é¢„å®šä¹‰çš„å¼‚å¸¸è¡Œä¸ºï¼Œåˆ™ä¼šäº§ç”Ÿå‘Šè­¦ã€‚å½“å‘Šè­¦å‘ç”Ÿæ—¶å¯ä»¥é€šè¿‡ webhook è§¦å‘é¢„å…ˆæ³¨å†Œçš„è¡Œä¸ºäº‹ä»¶ï¼Œä¾‹å¦‚é€šè¿‡å¾®ä¿¡å‘ŠçŸ¥ç®¡ç†å‘˜å½“å‰å‘Šè­¦ä¿¡æ¯ã€‚

**âœ¨ tracee-rules ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™å®ç°**

tracee-rules æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ï¼ˆSignaturesï¼‰ï¼Œç›®å‰æ”¯æŒä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š

- é€šè¿‡ Golang ç¼–ç å®ç° Signature æ¥å£ï¼Œç”¨æˆ·ä¾¿å¯ä»¥å®ç°é«˜åº¦å®šåˆ¶åŒ–çš„åŒ¹é…è§„åˆ™ä¸å“åº”é€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„æ–¹å¼ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Go Plugin çš„å½¢å¼ç¼–å†™ signatureï¼Œå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œä¸è¿‡è¿™ç§æ–¹å¼æœ‰è¯¸å¤šé™åˆ¶ï¼Œæ‰€ä»¥å¹¶ä¸è¢«æ¨èã€‚
- é€šè¿‡ [Rego](https://www.openpolicyagent.org/docs/latest/#rego) ç¼–å†™å®šåˆ¶åŒ–çš„ Signature. ç¼–å†™çš„ rule æ–‡ä»¶å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼Œ
```go
package tracee.TRC_2

__rego_metadoc__ := {
        "id": "TRC-2",
        "version": "0.1.0",
        "name": "Anti-Debugging",
        "description": "Process uses anti-debugging technique to block debugger",
        "tags": ["linux", "container"],
        "properties": {
                "Severity": 3,
                "MITRE ATT&CK": "Defense Evasion: Execution Guardrails",
        },
}

tracee_selected_events[eventSelector] {
        eventSelector := {
                "source": "tracee",
                "name": "ptrace",
        }
}

tracee_match {
        input.eventName == "ptrace"
        arg := input.args[_]
        arg.name == "request"
        arg.value == "PTRACE_TRACEME"
}
```
- é€šè¿‡ [Go-Cel](https://github.com/google/cel-go) ç¼–å†™å®šåˆ¶åŒ–çš„ Signature. éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§ç¼–å†™ rules çš„æ–¹å¼ç›®å‰ä»ç„¶å¤„äº POC (Proof Of Concept) é˜¶æ®µï¼Œæ˜¯ä¸€ä¸ªå®éªŒæ€§çš„åŠŸèƒ½ï¼Œç”¨äºæœ‰å¯èƒ½éœ€è¦æ·»åŠ ç›¸åº”çš„ä»£ç æ®µæ‰èƒ½å¤Ÿè®©ç¨‹åºæ­£å¸¸è¯†åˆ«æ‰€ç¼–å†™çš„ rulesï¼Œå¦‚æœä½ ä½¿ç”¨ **Go-Cel**ï¼Œç¼–å†™çš„ rule æ–‡ä»¶å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼Œ

```yaml
kind: SignaturesConfig
apiVersion: tracee.aquasecurity.github.io/v1alpha1
signatures:
  - metadata:
      id: "Mine-0.1.0"
      version: "0.1.0"
      name: "My Own Signature"
      description: "My Own Signature Detects Stuff"
      tags:
        - "linux"
    eventSelectors:
      - source: tracee
        name: openat
    expression: |-
        input.eventName == 'openat' &&
        input.stringArg('pathname').startsWith('/etc/passwd')

```

ç›®å‰ï¼ŒTracee å†…ç½®çš„ rules å¯ä»¥é€šè¿‡ `tracee-rules --list` å‘½ä»¤æŸ¥çœ‹ï¼Œè¿™é‡Œæˆªå–å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œ
```bash
ID         NAME                                VERSION DESCRIPTION
TRC-2      Anti-Debugging                      0.1.0   Process uses anti-debugging technique to block debugger
TRC-14     CGroups Release Agent File Modification 0.1.0   An Attempt to modify CGroups release agent file was detected. CGroups are a Linux kernel feature which can change a process's resource limitations. Adversaries may use this feature for container escaping.
TRC-3      Code injection                      0.1.0   Possible code injection into another process
TRC-11     Container Device Mount Detected     0.1.0   Container device filesystem mount detected. A mount of a host device filesystem can be exploited by adversaries to perform container escape.
TRC-9      New Executable Was Dropped During Runtime 0.1.0   An Executable file was dropped in your system during runtime. Usually container images are built with all binaries needed inside, a dropped binary may indicate an adversary infiltrated into your container
```

å¯ä»¥çœ‹åˆ°ï¼Œtracee-rules æ£€æµ‹å¼•æ“çš„å·¥ä½œæœ¬è´¨æ˜¯å¯¹è¯­ä¹‰åŒ–å®‰å…¨ç­–ç•¥ä¸æºäº‹ä»¶ä¿¡æ¯è¿›è¡ŒåŒ¹é…ï¼Œè‹¥äº‹ä»¶åœ¨ä¸Šä¸‹æ–‡è¯­ä¹‰ä¸­æºå¸¦æœ‰ç­–ç•¥æ‰€æŒ‡å®šçš„ä¿¡æ¯ï¼Œä¾¿ä¼šäº§ç”Ÿå‘Šè­¦ï¼Œæ‹¿ä¸Šé¢æåˆ°çš„ `Anti-Debugging` Signature ä¸ºä¾‹ï¼Œå…¶å…·ä½“çš„ç­–ç•¥ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼Œ

```Go
tracee_selected_events[eventSelector] {
        eventSelector := {
                "source": "tracee",
                "name": "ptrace",
        }
}

tracee_match {
        input.eventName == "ptrace"
        arg := input.args[_]
        arg.name == "request"
        arg.value == "PTRACE_TRACEME"
}
```

å…¶ä¸­ `eventSelector` æŒ‡å®šäº†æˆ‘ä»¬å…³å¿ƒçš„äº‹ä»¶åç§°ï¼Œè¿™æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¸åœ¨ `tracee-ebpf` ä¸­æŒ‡å®š `--trace event=ptrace` ç›¸å·®ä¸å¤§ï¼Œåœ¨ `tracee_match` ä¸­æŒ‡å®šäº†ç­–ç•¥æ‰€å…³å¿ƒçš„ç›¸å…³ `ptrace` ç³»ç»Ÿè°ƒç”¨å…¥å‚çš„ä¿¡æ¯ï¼Œå…¶ä¸­æŒ‡å®šäº† `request` å‚æ•°å€¼ä¸º `PTRACE_TRACEME` çš„ `ptrace` è°ƒç”¨ã€‚è‹¥åœ¨äº‹ä»¶æµä¸­å‡ºç°äº†æ»¡è¶³ä¸Šè¿°ç­–ç•¥å®šä¹‰çš„äº‹ä»¶ï¼Œtracee-rules ä¾¿ä¼šäº§ç”Ÿå‘Šè­¦ã€‚

{{< admonition type=tip title="ptrace æ‰‹å†Œ" open=false >}}
`ptrace` çš„å‡½æ•°ç­¾åå¦‚ä¸‹æ‰€ç¤ºï¼Œ

```C
       long ptrace(enum __ptrace_request request, pid_t pid,
                   void *addr, void *data);
```

å…¶ä¸­ä¸ `request` å…¥å‚å¯¹åº”å€¼ `PTRACE_TRACEME` çš„ç›¸å…³é‡Šä¹‰ä¸ºï¼Œ

```markdown
       PTRACE_TRACEME
              Indicate that this process is to be traced by its parent.  A process probably shouldn't make this request if its parent isn't expecting to trace it.  (pid, addr, and data are
              ignored.)

              The PTRACE_TRACEME request is used only by the tracee; the remaining requests are used only by the tracer.  In the following requests, pid specifies  the  thread  ID  of  the
              tracee to be acted on.  For requests other than PTRACE_ATTACH, PTRACE_SEIZE, PTRACE_INTERRUPT, and PTRACE_KILL, the tracee must be stopped.
```

æ›´å¤šçš„ä¿¡æ¯å¯ä»¥å‚è€ƒ[æ‰‹å†Œ](https://man7.org/linux/man-pages/man2/ptrace.2.html)ã€‚
{{< /admonition >}}

### æ€»ç»“
