<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº - p1nant0m</title><meta name="Description" content="p1nant0m"><meta property="og:title" content="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº" />
<meta property="og:description" content="eBPF ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ› The ability to attach eBPF programs to trace points as well as kernel and user application probe points allows unprecedented visibility into the runtime behavior of applications and the system itself. By giving introspection abilities to both the application and system side, both views can be combined, allowing powerful and unique insights to troubleshoot system performance problems. Advanced statistical data structures allow to extract meaningful visibility data in an efficient manner, without requiring the export of vast amounts of sampling data as typically done by similar systems. å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®è‡ªèº«çš„éœ€æ±‚ï¼Œè€ƒè™‘æ¸…æ¥šæˆ‘ä»¬éœ€è¦è·å–å“ªä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œå†ä»è¿™äº›æ•°æ®ä¿¡æ¯çš„ç±»å‹å‡ºå‘æ‰¾åˆ°å…¶å¯¹åº”çš„è¿½è¸ªä½ç½®ã€‚åœ¨ eBPF ç¨‹åºä¸­æœ‰ä»¥ä¸‹è¿™å‡ ç§å¸¸ç”¨çš„è¿½è¸ªç‚¹ç±»å‹ï¼š kprobe å†…æ ¸æ¢é’ˆ uprobe ç”¨æˆ·ç¨‹åºæ¢é’ˆ tracepoint å†…æ ¸" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://p1nant0m.com/2022-07-25-ebpf-tracing/" /><meta property="og:image" content="https://p1nant0m.com/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-24T14:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-24T14:00:00+00:00" /><meta property="og:site_name" content="p1nant0m" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://p1nant0m.com/logo.png"/>

<meta name="twitter:title" content="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº"/>
<meta name="twitter:description" content="eBPF ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ› The ability to attach eBPF programs to trace points as well as kernel and user application probe points allows unprecedented visibility into the runtime behavior of applications and the system itself. By giving introspection abilities to both the application and system side, both views can be combined, allowing powerful and unique insights to troubleshoot system performance problems. Advanced statistical data structures allow to extract meaningful visibility data in an efficient manner, without requiring the export of vast amounts of sampling data as typically done by similar systems. å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®è‡ªèº«çš„éœ€æ±‚ï¼Œè€ƒè™‘æ¸…æ¥šæˆ‘ä»¬éœ€è¦è·å–å“ªä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œå†ä»è¿™äº›æ•°æ®ä¿¡æ¯çš„ç±»å‹å‡ºå‘æ‰¾åˆ°å…¶å¯¹åº”çš„è¿½è¸ªä½ç½®ã€‚åœ¨ eBPF ç¨‹åºä¸­æœ‰ä»¥ä¸‹è¿™å‡ ç§å¸¸ç”¨çš„è¿½è¸ªç‚¹ç±»å‹ï¼š kprobe å†…æ ¸æ¢é’ˆ uprobe ç”¨æˆ·ç¨‹åºæ¢é’ˆ tracepoint å†…æ ¸"/>
<meta name="application-name" content="æˆ‘çš„ç½‘ç«™">
<meta name="apple-mobile-web-app-title" content="æˆ‘çš„ç½‘ç«™"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://p1nant0m.com/2022-07-25-ebpf-tracing/" /><link rel="prev" href="https://p1nant0m.com/2022-07-18-xdp-tutorial/" /><link rel="next" href="https://p1nant0m.com/2022-07-18-%E5%A4%A7%E7%99%BD%E8%AF%9D%E8%AE%B2gochannel%E5%AE%9E%E7%8E%B0/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/p1nant0m.com\/2022-07-25-ebpf-tracing\/"
        },"genre": "posts","keywords": "eBPF, tracing, tutorial","wordcount":  2831 ,
        "url": "https:\/\/p1nant0m.com\/2022-07-25-ebpf-tracing\/","datePublished": "2022-07-24T14:00:00+00:00","dateModified": "2022-07-24T14:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "p1nant0m"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84EW6PHH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-CX84EW6PHH');
    </script>
    
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="p1nant0m"><span id="id-2" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="/friends/"> å‹é“¾ </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/2022-07-25-ebpf-tracing/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84EW6PHH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-CX84EW6PHH');
    </script>

    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="p1nant0m"><span id="id-3" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="/friends/" title="">å‹é“¾</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/2022-07-25-ebpf-tracing/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº</h1><h2 class="single-subtitle">ä¸€äº›å­¦ä¹  eBPF è¿½è¸ªç¨‹åºç¼–å†™çš„è®°å½•ä»¥åŠå¼€æºä»£ç å®ä¾‹åˆ†æ</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>p1nant0m</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-07-24">2022-07-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;çº¦ 2831 å­—&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;é¢„è®¡é˜…è¯» 6 åˆ†é’Ÿ&nbsp;<span id="/2022-07-25-ebpf-tracing/" class="leancloud_visitors" data-flag-title="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº">
                        <i class="far fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ebpf-ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ›">eBPF ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ›</a></li>
        <li><a href="#å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹">å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹ï¼Ÿ</a>
          <ul>
            <li><a href="#kprobe-a-idkprobea">kprobe <a id="kprobe"></a></a></li>
            <li><a href="#wip-">WIP ğŸ±</a></li>
            <li><a href="#uprobe-a-iduprobea">uprobe <a id="uprobe"></a></a></li>
            <li><a href="#tracepoint">tracepoint</a></li>
            <li><a href="#raw_tracepoint">raw_tracepoint</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://image.p1nant0m.com/header_opensource.png"
        data-srcset="https://image.p1nant0m.com/header_opensource.png, https://image.p1nant0m.com/header_opensource.png 1.5x, https://image.p1nant0m.com/header_opensource.png 2x"
        data-sizes="auto"
        alt="https://image.p1nant0m.com/header_opensource.png"
        title="header_" /></p>
<h3 id="ebpf-ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ›">eBPF ç¨‹åºçš„è·Ÿè¸ªèƒ½åŠ›</h3>
<div id="id-1">The ability to attach eBPF programs to trace points as well as kernel and user application probe points allows unprecedented visibility into the runtime behavior of applications and the system itself. By giving introspection abilities to both the application and system side, both views can be combined, allowing powerful and unique insights to troubleshoot system performance problems. Advanced statistical data structures allow to extract meaningful visibility data in an efficient manner, without requiring the export of vast amounts of sampling data as typically done by similar systems.</div>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ebpf.io/static/intro_tracing-ffa5e3fa3407ecb445b1549f85f590f5.png"
        data-srcset="https://ebpf.io/static/intro_tracing-ffa5e3fa3407ecb445b1549f85f590f5.png, https://ebpf.io/static/intro_tracing-ffa5e3fa3407ecb445b1549f85f590f5.png 1.5x, https://ebpf.io/static/intro_tracing-ffa5e3fa3407ecb445b1549f85f590f5.png 2x"
        data-sizes="auto"
        alt="https://ebpf.io/static/intro_tracing-ffa5e3fa3407ecb445b1549f85f590f5.png"
        title="img" /></p>
<h3 id="å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹">å¦‚ä½•æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„è¿½è¸ªç‚¹ï¼Ÿ</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®è‡ªèº«çš„éœ€æ±‚ï¼Œè€ƒè™‘æ¸…æ¥šæˆ‘ä»¬éœ€è¦è·å–å“ªä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œå†ä»è¿™äº›æ•°æ®ä¿¡æ¯çš„ç±»å‹å‡ºå‘æ‰¾åˆ°å…¶å¯¹åº”çš„è¿½è¸ªä½ç½®ã€‚åœ¨ eBPF ç¨‹åºä¸­æœ‰ä»¥ä¸‹è¿™å‡ ç§å¸¸ç”¨çš„è¿½è¸ªç‚¹ç±»å‹ï¼š</p>
<ul>
<li><a href="#kprobe" rel="">kprobe å†…æ ¸æ¢é’ˆ</a></li>
<li><a href="#uprobe" rel="">uprobe ç”¨æˆ·ç¨‹åºæ¢é’ˆ</a></li>
<li>tracepoint å†…æ ¸é™æ€è·Ÿè¸ªç‚¹</li>
<li>raw_tracepoint åŸå§‹è·Ÿè¸ªç‚¹</li>
</ul>
<p>çŸ¥é“äº†æœ‰å“ªäº›ç§ç±»çš„è·Ÿè¸ªç‚¹è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ ¹æ®è‡ªèº«çš„éœ€æ±‚æ‰¾åˆ°å¯¹åº”ç±»å‹å…·ä½“çš„è·Ÿè¸ªç‚¹å¯¹è±¡ã€‚</p>
<h4 id="kprobe-a-idkprobea">kprobe <a id="kprobe"></a></h4>
<p>å¯¹äº krpobe ç±»å‹å†…æ ¸æ¢é’ˆæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>bpftrace</code> å·¥å…·æŸ¥çœ‹æ”¯æŒçš„æ‰€æœ‰å†…æ ¸æ¢é’ˆï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ CLI ç»ˆç«¯ä¸­é”®å…¥ <code>bpftrace -l &quot;kprobe:*&quot;</code>  ä¾¿å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„å†…æ ¸æ¢é’ˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">kprobe:zswap_free_entry
kprobe:zswap_frontswap_init
kprobe:zswap_frontswap_invalidate_area
kprobe:zswap_frontswap_invalidate_page
kprobe:zswap_frontswap_load
kprobe:zswap_frontswap_store
</code></pre></td></tr></table>
</div>
</div><p>å¯¹äºæ¯ä¸€ä¸ªå†…æ ¸æ¢é’ˆæ¥è¯´ï¼Œå®ƒéƒ½å°†è¢«æŒ‚è½½åœ¨å¯¹åº”çš„å†…æ ¸å‡½æ•°ä¹‹ä¸Šï¼Œå½“è¯¥å†…æ ¸å‡½æ•°è¢«è°ƒç”¨åä¾¿ä¼šè§¦å‘æˆ‘ä»¬ Hook åœ¨å…¶ä¹‹ä¸Šçš„ eBPF å¤„ç†å‡½æ•°ã€‚å¦‚ <code>zswap_free_entry</code> å‡½æ•°ï¼Œåœ¨ <a href="https://elixir.bootlin.com/" target="_blank" rel="noopener noreffer ">https://elixir.bootlin.com/</a> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ Linux kernel æŸ¥çœ‹ç›¸å…³å†…æ ¸å‡½æ•°çš„å‡½æ•°ç­¾åå’Œå®ç°ï¼Œ<code>zswap_free_entry</code> å‡½æ•°çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Carries out the common pattern of freeing and entry&#39;s zpool allocation,
</span><span class="cm"> * freeing the entry itself, and decrementing the number of stored pages.
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zswap_free_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">zswap_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zswap_same_filled_pages</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">zpool_free</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">zpool</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">zswap_pool_put</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">zswap_entry_cache_free</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zswap_stored_pages</span><span class="p">);</span>
	<span class="n">zswap_update_total_size</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åˆ°è¿™å…ˆåœæ­¢ä»¥ä¸‹ï¼Œçœ‹çœ‹æˆ‘ä»¬ç›®å‰ä¸ºæ­¢éƒ½åšäº†å“ªä¸€äº›å·¥ä½œï¼š1ï¼‰ç¡®å®šè‡ªèº«è¿›è¡Œç³»ç»Ÿç›‘æ§çš„éœ€æ±‚ï¼›ï¼ˆ2ï¼‰æ ¹æ®éœ€æ±‚æ‰¾åˆ°éœ€è¦è¿›è¡Œè·Ÿè¸ªçš„å¯¹è±¡ï¼ˆåœ¨è¿™é‡Œä¾¿æ˜¯æˆ‘ä»¬å…·ä½“çš„ kprobeï¼‰ï¼›3ï¼‰äº†è§£ç›¸å…³ kprobe æŒ‚è½½çš„å†…æ ¸å‡½æ•°ç­¾åï¼Œ<strong>æ›´è¿›ä¸€æ­¥å¯ä»¥æ˜ç¡®å‡½æ•°çš„è°ƒç”¨é“¾ï¼Œå°†å…¶ä¸å…·ä½“çš„äº‹ä»¶ç›¸å…³è”</strong>ã€‚</p>
<div class="details admonition tip">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>æƒ³åˆ°çš„è¯å°±å¾—è¯´ ğŸ˜€<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>äº‹ä»¶æ˜¯è§¦å‘ä¸€ç³»åˆ—æ“ä½œçš„å› ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>cat foo.txt</code> å‘½ä»¤å°† <code>foo.txt</code> æ–‡ä»¶çš„å†…å®¹è¾“å‡ºè‡³æ ‡å‡†è¾“å‡ºæµä¸­æ—¶å°±æ¶‰åŠåˆ°äº†æ“ä½œç³»ç»Ÿçš„ä¸€ç³»åˆ—æ“ä½œï¼ˆæ‰§è¡Œ <code>/usr/bin/cat</code> äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå†…å­˜ç”³è¯·ä¸åˆ†é…ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œè¯»å†™æ–‡ä»¶ç­‰ï¼‰ï¼ŒæœŸé—´æ“ä½œç³»ç»Ÿæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç”±ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œè¿›è€Œåœ¨å†…æ ¸ç©ºé—´ä¸­æ‰§è¡Œç›¸å…³çš„é€»è¾‘ã€‚åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„èƒ½åŠ›ä¸ºä¸Šå±‚åº”ç”¨æä¾›å¯¹åº”çš„æœåŠ¡ï¼Œè®©åº”ç”¨æ— éœ€å…³å¿ƒå¤æ‚çš„èµ„æºåˆ†é…ä¸è°ƒåº¦é—®é¢˜ï¼ˆCPUã€å†…å­˜ã€I/Oï¼‰ã€‚</p>
<p>ä¸è¿‡ï¼Œäº†è§£å†…æ ¸å‡½æ•°ä½•æ—¶è¢«è°ƒç”¨ã€è¢«è°è°ƒç”¨æ˜¯ä¸€ä¸ªè¾ƒé«˜çš„è¦æ±‚ï¼Œå®ƒéœ€è¦ä½ å¯¹æ“ä½œç³»ç»Ÿã€å¯¹å†…æ ¸å®ç°ååˆ†ç†Ÿæ‚‰ï¼Œå¯¹äºéå†…æ ¸å¼€å‘è€…æ¥è¯´æ— ç–‘ååˆ†è‹¦æ¼ã€‚</p>
<p>ä¸è¿‡æœ‰äº† eBPF ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•°è°ƒç”¨æ ˆæ‰¾åˆ°ä¸Šå±‚çš„ callerï¼Œè¿›è€Œè§‚å¯Ÿè¢« Hook å‡½æ•°è°ƒç”¨çš„å…¨è¿‡ç¨‹ï¼Œå®ç°å¯¹è§¦å‘äº‹ä»¶çš„æº¯æºã€‚é€šè¿‡åœ¨æ•æ„Ÿå‡½æ•°ä¸Š Hook eBPF ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å¹¶è®°å½•ç³»ç»Ÿä¸­å‘ç”Ÿçš„å¼‚å¸¸è¡Œä¸ºï¼Œä»è€Œä¸ºäº‹åçš„åˆ†ææº¯æºä»¥åŠæ‹¦æˆªé˜»æ–­æä¾›å……è¶³çš„å†³æ–­ä¾æ®ã€‚</p>
</div>
        </div>
    </div>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦ç€æ‰‹å¼€å§‹ eBPF ç¨‹åºçš„ç¼–å†™äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸€ä¸ª eBPF ç¨‹åºçš„åŸºæœ¬å…ƒç´ ã€‚</p>
<ul>
<li><strong>SEC Macro</strong>: SEC å®å±•å¼€åç”¨äºåˆ›å»º ELF Section ï¼Œå¸®åŠ© BPF åŠ è½½å™¨æ‰¾åˆ°å¯¹åº”å…ƒç´ çš„ä½ç½®ï¼Œæ¯”å¦‚åƒ libbpf åº“å°±å¯ä»¥é€šè¿‡ ELF æ–‡ä»¶ä¸­ç›¸åº”çš„ Section æ¥æ‰¾åˆ°å¹¶åŠ è½½å¯¹åº”çš„ eBPF ç¨‹åºã€‚</li>
<li><strong>LICENSE</strong>: eBPF ç¨‹åºçš„æˆæƒè®¸å¯è¯ï¼Œé€šå¸¸ä½¿ç”¨ GPL è®¸å¯ã€‚</li>
</ul>
<p>å¯¹äº kprobe ç±»å‹çš„ eBPF ç¨‹åºï¼ˆBPF_PROG_TYPE_KPROBEï¼‰æ¥è¯´ï¼Œé€šå¸¸ä»¥ <code>SEC(kprobe/kernel_function_name)</code> æ–¹å¼ä½¿ç”¨ï¼Œæ¯”å¦‚ <code>SEC(kprobe/zswap_free_entry)</code> ã€‚åœ¨å…¶å®ƒç±»å‹çš„ eBPF ç¨‹åºä¸Šä¹Ÿå¤§åŒå°å¼‚ï¼Œé€šå¸¸ä¸º <code>SEC(bpf_prog_type/instance_name)</code> ï¼Œä¾‹å¦‚ tracepoint ç±»å‹çš„ eBPF ç¨‹åºä½¿ç”¨ <code>SEC(tracepoint/tracepoint_name)</code> å¯¹ eBPF å‡½æ•°è¿›è¡Œå£°æ˜ã€‚</p>
<p>ä¸Šè¿°å·¥ä½œéƒ½åšå®Œåï¼Œæˆ‘ä»¬å°±æ­£å¼è¿›å…¥åˆ° eBPF ç¨‹åºçš„ç¼–å†™è¿‡ç¨‹äº†ï¼Œåœ¨ç¼–å†™ eBPF ç¨‹åºæ—¶æˆ‘ä»¬è¦ç¡®å®šå¯¹äº eBPF ç¨‹åºç±»å‹å‡½æ•°çš„å…¥å‚ã€‚åœ¨ kprobe ç±»å‹çš„ eBPF å‡½æ•°ä¸­ï¼Œæˆ‘è§åˆ°äº†ååˆ†å¤šå¯¹ä¼ å…¥æŒ‡é’ˆä¸åŒçš„ç±»å‹è§£é‡Šï¼Œæˆ‘ä»¬éƒ½ä¸€èµ·æ¥çœ‹çœ‹å„é¡¹ç›®å®ç°éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œ</p>
<p>åœ¨ <a href="https://github.com/aquasecurity/tracee" target="_blank" rel="noopener noreffer ">tracee</a> ä¸­ä½¿ç”¨äº† libbpf åº“æä¾›çš„ BPF_KPROBE Macro å»å®šä¹‰å®ƒä»¬çš„ kprobe ç±»å‹ eBPF ç¨‹åºï¼Œè¯¥å®å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * BPF_KPROBE serves the same purpose for kprobes as BPF_PROG for
</span><span class="cm"> * tp_btf/fentry/fexit BPF programs. It hides the underlying platform-specific
</span><span class="cm"> * low-level way of getting kprobe input arguments from struct pt_regs, and
</span><span class="cm"> * provides a familiar typed and named function arguments syntax and
</span><span class="cm"> * semantics of accessing kprobe input paremeters.
</span><span class="cm"> *
</span><span class="cm"> * Original struct pt_regs* context is preserved as &#39;ctx&#39; argument. This might
</span><span class="cm"> * be necessary when using BPF helpers like bpf_perf_event_output().
</span><span class="cm"> */</span>
<span class="cp">#define BPF_KPROBE(name, args...)					    \
</span><span class="cp">name(struct pt_regs *ctx);						    \
</span><span class="cp">static __attribute__((always_inline)) typeof(name(0))			    \
</span><span class="cp">____##name(struct pt_regs *ctx, ##args);				    \
</span><span class="cp">typeof(name(0)) name(struct pt_regs *ctx)				    \
</span><span class="cp">{									    \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic push&#34;)					    \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic ignored \&#34;-Wint-conversion\&#34;&#34;)		    \
</span><span class="cp">	return ____##name(___bpf_kprobe_args(args));			    \
</span><span class="cp">	_Pragma(&#34;GCC diagnostic pop&#34;)					    \
</span><span class="cp">}									    \
</span><span class="cp">static __attribute__((always_inline)) typeof(name(0))			    \
</span><span class="cp">____##name(struct pt_regs *ctx, ##args)
</span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡æ³¨é‡Šä»¥åŠå®å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å®çš„ç”¨é€”ä¸»è¦æ˜¯æ¶ˆé™¤äº†ä¸åŒå¹³å°ä» <code>struct *pt_regs</code> ä¸­è¯»å–æ•°æ®çš„å·®å¼‚ï¼Œå…·ä½“çš„å…¥å‚è¿˜æ˜¯ <code>struct *pt_regs</code> ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ <code>args</code> æŒ‡å®šå…¶å®ƒçš„å‚æ•°ã€‚</p>
<p>é€šè¿‡ <code>struct *pt_regs</code> æˆ‘ä»¬èƒ½å¤Ÿè·å¾—è°ƒç”¨è¢« Hook å‡½æ•°æ—¶å¯„å­˜å™¨çš„çŠ¶æ€ï¼Œå¹¶èƒ½å¤Ÿè·å–å…¶ä¸­çš„æ•°æ®ã€‚å¯¹äºä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œä½¿ç”¨ <code>BPF_KPROBE</code> å®èƒ½ä¸ºæˆ‘ä»¬æŠ¹é™¤å¹³å°å·®å¼‚ï¼Œè®©ç¨‹åºå‘˜èƒ½å¤Ÿä»¥æœ€ç†Ÿæ‚‰çš„æ–¹å¼ç¼–å†™ eBPF ç¨‹åºï¼Œ<code>struct *pt_regs</code> çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">pt_regs</span> <span class="p">{</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r15</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r14</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r13</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r12</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bx</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r11</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r10</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r9</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r8</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ax</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dx</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">orig_ax</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ip</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ss</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ä¸€äº›è¾…åŠ©å®ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å–åˆ°è¢« Hook å‡½æ•°çš„å…¥å‚ï¼Œåœ¨ libbpf åº“ä¸­ä¾¿æœ‰å¦‚ä¸‹çš„å®å¯ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define PT_REGS_PARM1(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM1_REG)
</span><span class="cp">#define PT_REGS_PARM2(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM2_REG)
</span><span class="cp">#define PT_REGS_PARM3(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM3_REG)
</span><span class="cp">#define PT_REGS_PARM4(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM4_REG)
</span><span class="cp">#define PT_REGS_PARM5(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM5_REG)
</span><span class="cp">#define PT_REGS_RET(x) (__PT_REGS_CAST(x)-&gt;__PT_RET_REG)
</span><span class="cp">#define PT_REGS_FP(x) (__PT_REGS_CAST(x)-&gt;__PT_FP_REG)
</span><span class="cp">#define PT_REGS_RC(x) (__PT_REGS_CAST(x)-&gt;__PT_RC_REG)
</span><span class="cp">#define PT_REGS_SP(x) (__PT_REGS_CAST(x)-&gt;__PT_SP_REG)
</span><span class="cp">#define PT_REGS_IP(x) (__PT_REGS_CAST(x)-&gt;__PT_IP_REG)
</span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œè¿™äº›å®è·å–å‡½æ•°å…¥å‚çš„æ–¹å¼ä¹Ÿå¹¶ä¸ç›¸åŒï¼Œåœ¨ x86 å¹³å°ä¸‹ï¼Œå®ƒä»¬è·å–å‡½æ•°å…¥å‚çš„æ–¹å¼å¦‚ä¸‹ï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define __PT_PARM1_REG di
</span><span class="cp">#define __PT_PARM2_REG si
</span><span class="cp">#define __PT_PARM3_REG dx
</span><span class="cp">#define __PT_PARM4_REG cx
</span><span class="cp">#define __PT_PARM5_REG r8
</span><span class="cp">#define __PT_RET_REG sp
</span><span class="cp">#define __PT_FP_REG bp
</span><span class="cp">#define __PT_RC_REG ax
</span><span class="cp">#define __PT_SP_REG sp
</span><span class="cp">#define __PT_IP_REG ip
</span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>æ–°çŸ¥<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>ä¸åŒçš„ç¼–è¯‘è¯­è¨€ä½¿ç”¨ä¸åŒçš„è°ƒç”¨æƒ¯ä¾‹ (calling convention)ï¼Œç”¨äºè§„å®šè°ƒç”¨æ–¹ä¸è¢«è°ƒç”¨æ–¹å¯¹å‡½æ•°è°ƒç”¨çš„å…±è¯†ã€‚</p>
<p>è¿™äº›å…±è¯†æœ‰ï¼šå‡½æ•°å‚æ•°ã€è¿”å›å€¼ä½¿ç”¨ä½•ç§æ–¹å¼è¿›è¡Œä¼ é€’ä»¥åŠå‚æ•°çš„ä¼ é€’é¡ºåºã€ä¼ é€’æ–¹å¼å¦‚ä½•ç­‰ã€‚</p>
<p>å‡½æ•°å‚æ•°æ—¢å¯ä»¥æ”¾åœ¨å¯„å­˜å™¨ä¸­è¿›è¡Œä¼ é€’ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å †æ ˆä¸­è¿›è¡Œä¼ é€’ï¼ˆPlan 9 ABIï¼‰ï¼Œç”±äº Linux Kernel ä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå…¶è°ƒç”¨æƒ¯ä¾‹éµå¾ª C ç¼–è¯‘å™¨çš„è§„åˆ™ï¼Œä½¿ç”¨å¯„å­˜å™¨è¿›è¡Œå‡½æ•°è°ƒç”¨å‚æ•°åŠè¿”å›å€¼çš„ä¼ é€’ã€‚</p>
</div>
        </div>
    </div>
<p>ä½¿ç”¨ <code>PT_REGS_PARM1(ctx)</code> ä¾¿å¯ä»¥è·å–åˆ°å‡½æ•°çš„ç¬¬ä¸€ä¸ªå…¥å‚ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¶å®ƒç›¸åº”çš„å®è·å–æ‰€æœ‰å‡½æ•°å…¥å‚ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“å‡½æ•°çš„ç­¾åï¼Œä½¿ç”¨ç±»å‹è½¬æ¢ä¾¿å¯ä»¥è·å–åˆ°å¯¹åº”æ•°æ®ç±»å‹çš„å‡½æ•°å…¥å‚ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåç»­çš„å¤„ç†ã€‚æ¯”å¦‚åœ¨ä¸Šè¿° <code>zswap_free_entry</code> ä¸­ï¼Œä½¿ç”¨ <code>entry = (struct zswap_entry *) PT_REGS_PAMR1(ctx)</code> ä¾¿å¯ä»¥è·å¾—ç¬¬ä¸€ä¸ªå‡½æ•°å…¥å‚ã€‚</p>
<blockquote>
<p>åœ¨ç¼–å†™ eBPF ç¨‹åºæ—¶å¼•å…¥ <code>vmlinux.h</code> å¤´å¯ä»¥ä¸€æ¬¡æ€§å¯¼å…¥å†…æ ¸æ‰€æœ‰ä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„ã€‚</p>
<p>ä½¿ç”¨ <code>bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code> å‘½ä»¤å¯ä»¥å¯¼å‡º <code>vmlinux.h</code> æ–‡ä»¶ã€‚</p>
</blockquote>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å·²ç»å¯ä»¥ä½¿ç”¨ BPF Map å‘ç”¨æˆ·ä¾§è¿è¡Œçš„ç¨‹åºæäº¤å†…æ ¸å‘ç”Ÿçš„äº‹ä»¶ä¿¡æ¯ï¼Œä»è€Œç›‘æ§ç³»ç»Ÿå†…éƒ¨çš„è¿è¡ŒçŠ¶æ€äº†ã€‚ä¸è¿‡ï¼Œé™¤äº†è¢« Hook å‡½æ•°çš„å…¥å‚ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜æƒ³è¦è·å–å…¶å®ƒæ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰§è¡Œå‡½æ•°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¿¡æ¯ï¼Œbpf_helpers ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†è·å–è¿™äº›ä¿¡æ¯çš„é€”å¾„ï¼Œå¸¸ç”¨çš„å‡½æ•°æœ‰ï¼Œ</p>
<ul>
<li>bpf_get_current_cgroup_id</li>
<li>bpf_get_current_ancestor_cgroup_id</li>
<li>bpf_get_current_comm</li>
<li>bpf_get_current_pid_tgid</li>
<li>bpf_get_current_task</li>
<li>bpf_get_current_task_btf</li>
<li>bpf_get_current_uid_gid</li>
<li>bpf_get_ns_current_pid_tgid</li>
</ul>
<p>è¿™äº›å‡½æ•°çš„ä½¿ç”¨æ–¹å¼ä»¥åŠç”¨é€”éƒ½å¯ä»¥åœ¨ bpf-helpers ä¸­æŸ¥çœ‹ï¼Œä¾‹å¦‚ <code>bpf_get_current_task</code> çš„æ–‡æ¡£ï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">       u64 bpf_get_current_task(void)

              Return A pointer to the current task struct.
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ eBPF ç¨‹åºä¸­ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½éœ€è¦ä»æŸä¸€æ®µå†…å­˜ç©ºé—´ä¸­è·å–æ•°æ®ï¼Œè¿™é‡Œçš„å†…å­˜ç©ºé—´å¯èƒ½æ˜¯ä½äºç”¨æˆ·æ€çš„ä¹Ÿå¯èƒ½æ˜¯ä½äºå†…æ ¸æ€çš„ï¼Œæˆ‘ä»¬æƒ³è¦å°†è¿™äº›æ•°æ®ä» eBPF ç¨‹åºé€šè¿‡ BPF Maps ä¼ é€’ç»™ç”¨æˆ·æ€ç¨‹åºå°±éœ€è¦æ‹·è´è¿™äº›å†…å­˜ç©ºé—´ä¸­çš„æ•°æ®ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ° BPF ä¸­çš„è¯»ç³»åˆ—å‡½æ•°ã€‚</p>
<p>é€šç”¨æƒ…å†µï¼ˆä¸€èˆ¬æ¥è¯´æˆ‘ä»¬éƒ½æ¨èä½¿ç”¨ç›®æ ‡æ›´åŠ æ˜ç¡®çš„å‡½æ•°ï¼‰ï¼š</p>
<ul>
<li>bpf_probe_read</li>
</ul>
<p>åœ¨ç”¨æˆ·æ€ä¸€ä¾§ï¼š</p>
<ul>
<li>bpf_probe_read_user</li>
<li>bpf_probe_read_user_str</li>
</ul>
<p>åœ¨å†…æ ¸æ€ä¸€ä¾§ï¼š</p>
<ul>
<li>bpf_probe_read_kernel</li>
<li>bpf_probe_read_kernel_str</li>
</ul>
<p>éœ€è¦æ³¨æ„åç¼€å¸¦ <code>_str</code> çš„å‡½æ•°ï¼Œå…¶ç”¨æ³•ç¤ºä¾‹ä¸ºï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">bpf_probe_read_user_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">args_size</span><span class="p">],</span> <span class="n">ARGSIZE</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¹¶ä¸ä¼šä» <code>argp</code> æŒ‡é’ˆæŒ‡å‘çš„åŒºåŸŸè¯»å– <code>ARGSIZE</code> å­—èŠ‚æ•°ç›®çš„å†…å®¹ï¼Œè€Œæ˜¯è¯»å–ä» <code>argp</code> å¼€å§‹åˆ°å­—ç¬¦ä¸²ç»“æŸæ ‡è¯†ç¬¦ <code>\x00</code> ä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>\x00</code> å­—ç¬¦éœ€è¦åŒ…å«åœ¨æœ€å¤§è¯»å–å­—ç¬¦é•¿åº¦ <code>ARGSIZE</code> ä»¥å†…ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ç¼–å†™ä¸€ä¸ªåŠŸèƒ½ååˆ†å®Œå–„çš„ eBPF kprobe ç¨‹åºäº†ï¼Œä½†å¦‚æœéœ€è¦å®ç°æ›´ä¸ºå¤æ‚çš„é€»è¾‘ï¼Œè”åŠ¨å…¶å®ƒçš„ eBPF ç¨‹åºé‚£å°±éœ€è¦ BPF Map çš„æ”¯æŒï¼Œå……åˆ†å‘æŒ¥ç¨‹åºå‘˜çš„æƒ³è±¡åŠ›äº†ã€‚</p>
<h4 id="wip-">WIP ğŸ±</h4>
<h4 id="uprobe-a-iduprobea">uprobe <a id="uprobe"></a></h4>
<h4 id="tracepoint">tracepoint</h4>
<p>åœ¨ <code>/sys/kernel/tracing/event</code> è·¯å¾„ä¸‹èƒ½å¤Ÿæ‰¾åˆ°æ‰€æœ‰å¯ä»¥è¿½è¸ªçš„å†…æ ¸äº‹ä»¶</p>
<h4 id="raw_tracepoint">raw_tracepoint</h4>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2022-07-24</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2022-07-25-ebpf-tracing/index.md" target="_blank">é˜…è¯»åŸå§‹æ–‡æ¡£</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://p1nant0m.com/2022-07-25-ebpf-tracing/" data-title="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº" data-via="p1nant0m" data-hashtags="eBPF,tracing,tutorial"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://p1nant0m.com/2022-07-25-ebpf-tracing/" data-hashtag="eBPF"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Hacker News" data-sharer="hackernews" data-url="https://p1nant0m.com/2022-07-25-ebpf-tracing/" data-title="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://p1nant0m.com/2022-07-25-ebpf-tracing/" data-title="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://p1nant0m.com/2022-07-25-ebpf-tracing/" data-title="eBPF-tracing ä½¿ç”¨ eBPF ç¼–å†™ç›‘æ§ç±»ç¨‹åº"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/ebpf/">eBPF</a>,&nbsp;<a href="/tags/tracing/">tracing</a>,&nbsp;<a href="/tags/tutorial/">tutorial</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022-07-18-xdp-tutorial/" class="prev" rel="prev" title="XDP-tutorial å­¦ä¹ å¦‚ä½•ç¼–å†™ eBPF XDP ç¨‹åº"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>XDP-tutorial å­¦ä¹ å¦‚ä½•ç¼–å†™ eBPF XDP ç¨‹åº</a>
            <a href="/2022-07-18-%E5%A4%A7%E7%99%BD%E8%AF%9D%E8%AE%B2gochannel%E5%AE%9E%E7%8E%B0/" class="next" rel="next" title="å¤§ç™½è¯è®² Golang Channel å®ç°">å¤§ç™½è¯è®² Golang Channel å®ç°<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">p1nant0m</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/css/2f1ef0.min.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/index.umd.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":50},"comment":{"valine":{"appId":"UnWumtTxnhlvaMmfKV6lZwUy-gzGzoHsz","appKey":"egg4vgYXZCZTW8f4QbS5bDpL","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-CN","pageSize":10,"placeholder":"ä½ çš„è¯„è®º ...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"åŒæ„","link":"äº†è§£æ›´å¤š","message":"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-2":"ğŸ™‚P1nant0m","id-3":"ğŸ™‚P1nant0m"},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-2":["id-2"],"id-3":["id-3"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
